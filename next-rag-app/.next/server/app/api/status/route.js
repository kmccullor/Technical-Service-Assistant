"use strict";(()=>{var t={};t.id=6492,t.ids=[6492],t.modules={399:t=>{t.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4049:(t,e,s)=>{s.r(e),s.d(e,{originalPathname:()=>A,patchFetch:()=>S,requestAsyncStorage:()=>E,routeModule:()=>f,serverHooks:()=>w,staticGenerationAsyncStorage:()=>y});var a={};s.r(a),s.d(a,{GET:()=>g});var r=s(9303),n=s(8716),i=s(670),o=s(7070),c=s(1773),h=s(3897);let l=process.env.CHAT_MODEL??"llama3.2:1b",u=process.env.EMBEDDING_MODEL??"nomic-embed-text:v1.5";function p(t){return`This response was generated by the offline fallback model.

Prompt: ${t}

To enable real model responses configure OLLAMA_INSTANCES, OLLAMA_BASE_URL, or set USE_LOCAL_MODELS=true with a running cluster.`}class m{constructor(){h.N.registerWarmupHandler(async()=>{await this.listModels().catch(()=>{})})}async fetchJson(t,e,s){let a=AbortSignal.timeout(1e4),r=await fetch(`${t.replace(/\/$/,"")}${e}`,{...s,signal:a,headers:{"Content-Type":"application/json",...s.headers||{}}});if(!r.ok)throw Error(`Request failed (${r.status}) ${r.statusText}`.trim());return await r.json()}async isAvailable(){try{return await c.S.forceHealthCheck(),c.S.getStats().healthyInstances>0}catch{return!1}}async listModels(){try{let t=await c.S.getBestInstance(),e=await this.fetchJson(t,"/api/tags",{method:"GET"});if(Array.isArray(e.models)&&e.models.length>0)return e.models.map(t=>t.name).filter(t=>"string"==typeof t)}catch{}return[l,u]}async generateEmbeddings(t,e=u){let s=[];for(let a of t){try{let t=await c.S.getBestInstance(),r=await this.fetchJson(t,"/api/embeddings",{method:"POST",body:JSON.stringify({model:e,input:a})});if(Array.isArray(r.embedding)){s.push(r.embedding);continue}}catch{}s.push(function(t,e=128){let s=Array(e).fill(0);for(let a=0;a<t.length;a+=1){let r=t.charCodeAt(a),n=a%e;s[n]=(s[n]+r)%1}return s}(a))}return s}cacheKey(t,e,s){return JSON.stringify({model:e,messages:t,options:s})}async generateChatResponse(t,e=l,s={}){let a;let r=this.cacheKey(t,e,s),n=h.N.getCachedResponse(r);if(n)return n;try{let r=await c.S.getBestInstance(),n=await this.fetchJson(r,"/api/chat",{method:"POST",body:JSON.stringify({model:e,messages:t,options:{temperature:s.temperature??.2,top_p:s.top_p??.9,max_tokens:s.max_tokens??256,stream:!1},stream:!1})});a=n?.message?.content?.trim()||p(t[t.length-1]?.content??"")}catch{a=p(t[t.length-1]?.content??"")}return h.N.setCachedResponse(r,a),a}}let d=new m;async function g(){try{let t="true"===process.env.USE_LOCAL_MODELS,e=await d.isAvailable(),s=e?await d.listModels():[],a="true"===process.env.WEB_SEARCH_ENABLED||"true"===process.env.USE_RERANKER_WEBSEARCH;return o.NextResponse.json({localMode:t,ollamaAvailable:e,ollamaUrl:process.env.OLLAMA_BASE_URL||"http://localhost:11434",models:{embedding:process.env.EMBEDDING_MODEL,chat:process.env.CHAT_MODEL,available:s},config:{rerankerEnabled:"true"===process.env.RERANKER_ENABLED,webSearchEnabled:a,confidenceThreshold:process.env.CONFIDENCE_THRESHOLD}})}catch(t){return console.error("Status check error:",t),o.NextResponse.json({error:"Failed to check status"},{status:500})}}let f=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/status/route",pathname:"/api/status",filename:"route",bundlePath:"app/api/status/route"},resolvedPagePath:"/home/kmccullor/Projects/Technical-Service-Assistant/next-rag-app/app/api/status/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:E,staticGenerationAsyncStorage:y,serverHooks:w}=f,A="/api/status/route";function S(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:y})}},3897:(t,e,s)=>{s.d(e,{N:()=>r});class a{registerWarmupHandler(t){this.warmupHandlers.push(t)}setCachedResponse(t,e){this.cache.set(t,{key:t,value:e,timestamp:Date.now()}),this.stats.cacheSize=this.cache.size}getCachedResponse(t){let e=this.cache.get(t);if(e)return this.stats.cacheHits+=1,e.value;this.stats.cacheMisses+=1}hasCachedResponse(t){return this.cache.has(t)}clear(){this.cache.clear(),this.stats.cacheSize=0}isWarmingUp(){return this.warming}getStats(){return{...this.stats}}async triggerWarmup(){if(!this.warming){this.warming=!0,this.stats.totalWarmupAttempts+=1,this.stats.lastWarmup=Date.now();try{if(0===this.warmupHandlers.length)await new Promise(t=>setTimeout(t,50));else for(let t of this.warmupHandlers)await t();this.stats.successfulWarmups+=1}catch(t){throw this.stats.failedWarmups+=1,this.stats.lastError=t instanceof Error?t.message:String(t),t}finally{this.warming=!1}}}constructor(){this.warming=!1,this.stats={totalWarmupAttempts:0,successfulWarmups:0,failedWarmups:0,cacheHits:0,cacheMisses:0,cacheSize:0},this.cache=new Map,this.warmupHandlers=[]}}let r=new a},1773:(t,e,s)=>{function a(t){let e=t.trim();return e?e.startsWith("http://")||e.startsWith("https://")?e.replace(/\/$/,""):`http://${e.replace(/\/$/,"")}`:"http://localhost:11434"}s.d(e,{S:()=>n});class r{constructor(){this.pointer=0,this.totalRequests=0,this.totalErrors=0;let t=(process.env.OLLAMA_INSTANCES||process.env.OLLAMA_BASE_URL||"http://localhost:11434").split(",").map(a).filter((t,e,s)=>t&&s.indexOf(t)===e);this.instances=t.map(t=>({url:t,healthy:!0,responseTime:0,score:1,lastChecked:0,consecutiveFailures:0}))}getInstanceUrls(){return this.instances.map(t=>t.url)}async checkInstance(t){let e=Date.now();try{let s=AbortSignal.timeout(5e3),a=await fetch(`${t.url}/api/tags`,{method:"GET",signal:s});if(!a.ok)throw Error(`Unexpected status ${a.status}`);t.healthy=!0,t.responseTime=Date.now()-e,t.score=1/(t.responseTime+1),t.consecutiveFailures=0}catch{t.healthy=!1,t.responseTime=Date.now()-e,t.score=0,t.consecutiveFailures+=1,this.totalErrors+=1}finally{t.lastChecked=Date.now()}}async forceHealthCheck(){await Promise.all(this.instances.map(t=>this.checkInstance(t)))}async getBestInstance(){let t,e=this.instances.filter(t=>t.healthy);if(0===e.length&&(await this.forceHealthCheck(),e=this.instances.filter(t=>t.healthy)),e.length>0){let s=this.pointer%e.length;t=e[s],this.pointer=(s+1)%e.length}else t=this.instances[0];return this.totalRequests+=1,t?.url??"http://localhost:11434"}getStats(){let t=this.instances.filter(t=>t.healthy),e=t.length>0?t.reduce((t,e)=>t+e.responseTime,0)/t.length:0;return{totalInstances:this.instances.length,healthyInstances:t.length,averageResponseTime:e,totalRequests:this.totalRequests,totalErrors:this.totalErrors,instanceDetails:[...this.instances]}}setInstanceHealth(t,e){let s=a(t),r=this.instances.find(t=>t.url===s);r&&(r.healthy=e,r.score=e?1/(r.responseTime+1):0)}resetStats(){this.totalRequests=0,this.totalErrors=0,this.instances.forEach(t=>{t.responseTime=0,t.score=t.healthy?1:0})}}let n=new r}};var e=require("../../../webpack-runtime.js");e.C(t);var s=t=>e(e.s=t),a=e.X(0,[8948,5972],()=>s(4049));module.exports=a})();