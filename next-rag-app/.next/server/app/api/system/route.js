"use strict";(()=>{var e={};e.id=9600,e.ids=[9600],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6820:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>d,patchFetch:()=>f,requestAsyncStorage:()=>p,routeModule:()=>u,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m});var a={};s.r(a),s.d(a,{GET:()=>h,POST:()=>l});var r=s(9303),n=s(8716),i=s(670),c=s(1773),o=s(3897);async function h(){try{let e=c.S.getStats(),t=o.N.getStats();return Response.json({success:!0,loadBalancer:e,preWarmer:t,systemHealth:{timestamp:Date.now(),healthyInstances:e.healthyInstances,totalInstances:e.totalInstances,healthPercentage:e.healthyInstances/e.totalInstances*100,averageResponseTime:e.averageResponseTime,errorRate:e.totalErrors/Math.max(1,e.totalRequests),cacheWarmupStatus:o.N.isWarmingUp()?"warming":"ready"}})}catch(e){return console.error("Failed to get load balancer stats:",e),Response.json({success:!1,error:"Failed to retrieve system statistics",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function l(e){try{let t=await e.json(),{action:s,instanceUrl:a}=t;switch(s){case"force_health_check":return await c.S.forceHealthCheck(),Response.json({success:!0,message:"Health check completed",stats:c.S.getStats()});case"trigger_warmup":if(o.N.isWarmingUp())return Response.json({success:!1,message:"Warmup already in progress"});return o.N.triggerWarmup().catch(e=>{console.error("Background warmup failed:",e)}),Response.json({success:!0,message:"Warmup triggered successfully"});case"reset_stats":return c.S.resetStats(),Response.json({success:!0,message:"Statistics reset successfully"});case"set_instance_health":if(!a)return Response.json({success:!1,error:"instanceUrl required for set_instance_health"},{status:400});let{healthy:r}=t;if("boolean"!=typeof r)return Response.json({success:!1,error:"healthy must be a boolean"},{status:400});return c.S.setInstanceHealth(a,r),Response.json({success:!0,message:`Instance ${a} marked as ${r?"healthy":"unhealthy"}`});default:return Response.json({success:!1,error:`Unknown action: ${s}`},{status:400})}}catch(e){return console.error("Load balancer management failed:",e),Response.json({success:!1,error:"Management operation failed",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let u=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/system/route",pathname:"/api/system",filename:"route",bundlePath:"app/api/system/route"},resolvedPagePath:"/home/kmccullor/Projects/Technical-Service-Assistant/next-rag-app/app/api/system/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:g}=u,d="/api/system/route";function f(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}},3897:(e,t,s)=>{s.d(t,{N:()=>r});class a{registerWarmupHandler(e){this.warmupHandlers.push(e)}setCachedResponse(e,t){this.cache.set(e,{key:e,value:t,timestamp:Date.now()}),this.stats.cacheSize=this.cache.size}getCachedResponse(e){let t=this.cache.get(e);if(t)return this.stats.cacheHits+=1,t.value;this.stats.cacheMisses+=1}hasCachedResponse(e){return this.cache.has(e)}clear(){this.cache.clear(),this.stats.cacheSize=0}isWarmingUp(){return this.warming}getStats(){return{...this.stats}}async triggerWarmup(){if(!this.warming){this.warming=!0,this.stats.totalWarmupAttempts+=1,this.stats.lastWarmup=Date.now();try{if(0===this.warmupHandlers.length)await new Promise(e=>setTimeout(e,50));else for(let e of this.warmupHandlers)await e();this.stats.successfulWarmups+=1}catch(e){throw this.stats.failedWarmups+=1,this.stats.lastError=e instanceof Error?e.message:String(e),e}finally{this.warming=!1}}}constructor(){this.warming=!1,this.stats={totalWarmupAttempts:0,successfulWarmups:0,failedWarmups:0,cacheHits:0,cacheMisses:0,cacheSize:0},this.cache=new Map,this.warmupHandlers=[]}}let r=new a},1773:(e,t,s)=>{function a(e){let t=e.trim();return t?t.startsWith("http://")||t.startsWith("https://")?t.replace(/\/$/,""):`http://${t.replace(/\/$/,"")}`:"http://localhost:11434"}s.d(t,{S:()=>n});class r{constructor(){this.pointer=0,this.totalRequests=0,this.totalErrors=0;let e=(process.env.OLLAMA_INSTANCES||process.env.OLLAMA_BASE_URL||"http://localhost:11434").split(",").map(a).filter((e,t,s)=>e&&s.indexOf(e)===t);this.instances=e.map(e=>({url:e,healthy:!0,responseTime:0,score:1,lastChecked:0,consecutiveFailures:0}))}getInstanceUrls(){return this.instances.map(e=>e.url)}async checkInstance(e){let t=Date.now();try{let s=AbortSignal.timeout(5e3),a=await fetch(`${e.url}/api/tags`,{method:"GET",signal:s});if(!a.ok)throw Error(`Unexpected status ${a.status}`);e.healthy=!0,e.responseTime=Date.now()-t,e.score=1/(e.responseTime+1),e.consecutiveFailures=0}catch{e.healthy=!1,e.responseTime=Date.now()-t,e.score=0,e.consecutiveFailures+=1,this.totalErrors+=1}finally{e.lastChecked=Date.now()}}async forceHealthCheck(){await Promise.all(this.instances.map(e=>this.checkInstance(e)))}async getBestInstance(){let e,t=this.instances.filter(e=>e.healthy);if(0===t.length&&(await this.forceHealthCheck(),t=this.instances.filter(e=>e.healthy)),t.length>0){let s=this.pointer%t.length;e=t[s],this.pointer=(s+1)%t.length}else e=this.instances[0];return this.totalRequests+=1,e?.url??"http://localhost:11434"}getStats(){let e=this.instances.filter(e=>e.healthy),t=e.length>0?e.reduce((e,t)=>e+t.responseTime,0)/e.length:0;return{totalInstances:this.instances.length,healthyInstances:e.length,averageResponseTime:t,totalRequests:this.totalRequests,totalErrors:this.totalErrors,instanceDetails:[...this.instances]}}setInstanceHealth(e,t){let s=a(e),r=this.instances.find(e=>e.url===s);r&&(r.healthy=t,r.score=t?1/(r.responseTime+1):0)}resetStats(){this.totalRequests=0,this.totalErrors=0,this.instances.forEach(e=>{e.responseTime=0,e.score=e.healthy?1:0})}}let n=new r},9303:(e,t,s)=>{e.exports=s(517)}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[8948],()=>s(6820));module.exports=a})();