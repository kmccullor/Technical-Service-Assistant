(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[649],{6008:function(e,a,s){Promise.resolve().then(s.bind(s,4735))},4735:function(e,a,s){"use strict";s.r(a),s.d(a,{default:function(){return P}});var t=s(7437),n=s(2265),r=s(91),i=s(7689),l=s(6272),c=s(740),o=s(3927),d=s(2735),u=s(1723),h=s(2208),m=s(3807),x=s(1671),p=s(9388),f=s(8728),g=s(3247),j=s(6865),v=s(2869),b=s(6070),N=s(5974),y=s(4508);let _=n.forwardRef((e,a)=>{let{className:s,type:n,...r}=e;return(0,t.jsx)("input",{type:n,className:(0,y.cn)("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),ref:a,...r})});_.displayName="Input";let w=n.createContext(null),S=e=>{let{value:a,onValueChange:s,children:r}=e,[i,l]=n.useState(!1),c=n.useRef(null);return n.useEffect(()=>{let e=e=>{c.current&&!c.current.contains(e.target)&&l(!1)};if(i)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[i]),(0,t.jsx)(w.Provider,{value:{value:a,onValueChange:s,isOpen:i,setIsOpen:l},children:(0,t.jsx)("div",{ref:c,className:"relative",children:r})})},C=n.forwardRef((e,a)=>{let{className:s,children:r,...i}=e,l=n.useContext(w);if(!l)throw Error("SelectTrigger must be used within Select");return(0,t.jsxs)("button",{type:"button",ref:a,className:(0,y.cn)("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),onClick:()=>l.setIsOpen(!l.isOpen),...i,children:[r,(0,t.jsx)("svg",{className:(0,y.cn)("h-4 w-4 opacity-50 transition-transform",l.isOpen&&"rotate-180"),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{d:"m6 9 6 6 6-6"})})]})});C.displayName="SelectTrigger";let k=e=>{let{placeholder:a}=e,s=n.useContext(w);return(0,t.jsx)("span",{children:(null==s?void 0:s.value)||a||"Select..."})},A=e=>{let{children:a}=e,s=n.useContext(w);if(!s)throw Error("SelectContent must be used within Select");return s.isOpen?(0,t.jsx)("div",{className:"absolute top-full left-0 z-50 w-full min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95",children:a}):null},D=e=>{let{value:a,children:s}=e,r=n.useContext(w);if(!r)throw Error("SelectItem must be used within Select");return(0,t.jsxs)("div",{className:"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground cursor-pointer data-[selected=true]:bg-accent",onClick:()=>{r.onValueChange(a),r.setIsOpen(!1)},"data-selected":r.value===a,children:[r.value===a&&(0,t.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,t.jsx)("svg",{className:"h-4 w-4",fill:"currentColor",viewBox:"0 0 20 20",children:(0,t.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})}),s]})},T=n.createContext(null),E=e=>{let{defaultValue:a,value:s,onValueChange:r,children:i,className:l}=e,[c,o]=n.useState(a||"");return(0,t.jsx)(T.Provider,{value:{value:void 0!==s?s:c,onValueChange:r||o},children:(0,t.jsx)("div",{className:(0,y.cn)("w-full",l),children:i})})},O=n.forwardRef((e,a)=>{let{className:s,...n}=e;return(0,t.jsx)("div",{ref:a,className:(0,y.cn)("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",s),...n})});O.displayName="TabsList";let L=n.forwardRef((e,a)=>{let{className:s,value:r,...i}=e,l=n.useContext(T);return(0,t.jsx)("button",{ref:a,type:"button",className:(0,y.cn)("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",(null==l?void 0:l.value)===r?"bg-background text-foreground shadow-sm":"hover:bg-muted hover:text-foreground",s),onClick:()=>null==l?void 0:l.onValueChange(r),...i})});L.displayName="TabsTrigger";let R=n.forwardRef((e,a)=>{let{className:s,value:r,...i}=e,l=n.useContext(T);return(null==l?void 0:l.value)!==r?null:(0,t.jsx)("div",{ref:a,className:(0,y.cn)("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",s),...i})});R.displayName="TabsContent";var I=s(6110);let F=n.forwardRef((e,a)=>{let{className:s,...n}=e;return(0,t.jsx)("label",{ref:a,className:(0,y.cn)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",s),...n})});F.displayName="Label";var U=s(1245);function P(){let[e,a]=(0,n.useState)([]),[s,g]=(0,n.useState)(""),[j,y]=(0,n.useState)([]),[w,T]=(0,n.useState)([]),[P,V]=(0,n.useState)([]),[Z,q]=(0,n.useState)(!1),[z,J]=(0,n.useState)(""),[W,Y]=(0,n.useState)(""),[B,G]=(0,n.useState)(""),[K,X]=(0,n.useState)(""),[$,ee]=(0,n.useState)(!1),[ea,es]=(0,n.useState)(null),[et,en]=(0,n.useState)({rni_version_id:0,database_type:"PostgreSQL",database_name:"",created_by:""}),[er,ei]=(0,n.useState)(!1),{accessToken:el}=(0,U.a)(),ec=(0,n.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a={...e};return el&&(a.Authorization="Bearer ".concat(el)),a},[el]),[eo,ed]=(0,n.useState)(!1),[eu,eh]=(0,n.useState)(""),[em,ex]=(0,n.useState)(""),[ep,ef]=(0,n.useState)(null),eg=(0,n.useCallback)(async()=>{if(el)try{let e=await fetch("/api/reranker/data-dictionary/rni-versions",{headers:ec()}),t=await e.json();if(a(t),t.length>0&&!s){let e=t.find(e=>e.is_active)||t[0];g(e.version_number)}}catch(e){console.error("Failed to fetch RNI versions:",e)}},[el,ec,s]),ej=(0,n.useCallback)(async()=>{if(el){q(!0);try{let e=new URLSearchParams;s&&e.append("version_number",s),W&&e.append("database_name",W),B&&e.append("schema_name",B);let a=await fetch("/api/reranker/data-dictionary/schema-overview?".concat(e),{headers:ec()}),t=await a.json();y(t)}catch(e){console.error("Failed to fetch schema overview:",e)}finally{q(!1)}}},[el,ec,s,W,B]),ev=(0,n.useCallback)(async()=>{if(el&&s)try{let a=e.find(e=>e.version_number===s);if(!a)return;let t=await fetch("/api/reranker/data-dictionary/database-instances?rni_version_id=".concat(a.id),{headers:ec()}),n=await t.json();V(n)}catch(e){console.error("Failed to fetch database instances:",e)}},[el,ec,e,s]);(0,n.useEffect)(()=>{el&&eg()},[el,eg]),(0,n.useEffect)(()=>{el&&s&&ev()},[el,s,ev]),(0,n.useEffect)(()=>{el&&s&&ej()},[el,s,ej]);let eb=async e=>{if(el)try{let a=new URLSearchParams;s&&a.append("version_number",s),W&&a.append("database_name",W),B&&a.append("schema_name",B),e&&a.append("table_name",e);let t=await fetch("/api/reranker/data-dictionary/column-details?".concat(a),{headers:ec()}),n=await t.json();T(n),X(e)}catch(e){console.error("Failed to fetch column details:",e)}},eN=e=>{navigator.clipboard.writeText(e).then(()=>alert("Query copied to clipboard!")).catch(e=>console.error("Failed to copy text: ",e))},ey=async()=>{if(ea){if(!el){alert("Please sign in to upload schemas.");return}q(!0);try{let s=new FormData;s.append("file",ea),s.append("rni_version_id",et.rni_version_id.toString()),s.append("database_type",et.database_type),s.append("database_name",et.database_name),s.append("created_by",et.created_by);let t=await fetch("/api/data-dictionary/upload-schema",{method:"POST",headers:ec(),body:s});if(t.ok){var e,a;let s=await t.json();alert("Schema upload successful! Imported ".concat((null===(e=s.statistics)||void 0===e?void 0:e.tables)||0," tables and ").concat((null===(a=s.statistics)||void 0===a?void 0:a.columns)||0," columns.")),ee(!1),es(null),ej(),ev()}else{let e=await t.json();alert("Schema upload failed: ".concat(e.detail||"Unknown error"))}}catch(e){console.error("Schema upload error:",e),alert("Schema upload failed. Please try again.")}finally{q(!1)}}},e_=async()=>{if(eu&&em){q(!0);try{let e=new URLSearchParams({version1:eu,version2:em});W&&e.append("database_name",W);let a=await fetch("/api/reranker/data-dictionary/compare-schemas?".concat(e),{headers:ec()}),s=await a.json();ef(s)}catch(e){console.error("Failed to compare schemas:",e)}finally{q(!1)}}},ew=j.filter(e=>{if(W&&e.database_name!==W||B&&e.schema_name!==B)return!1;if(z){let a=z.toLowerCase();return e.table_name.toLowerCase().includes(a)||e.schema_name.toLowerCase().includes(a)||e.database_name.toLowerCase().includes(a)||(e.table_description||"").toLowerCase().includes(a)}return!0}),eS=[...new Set(j.map(e=>e.database_name))],eC=[...new Set(j.filter(e=>!W||e.database_name===W).map(e=>e.schema_name))];return(0,t.jsxs)("div",{className:"container mx-auto p-6 space-y-6",children:[(0,t.jsxs)("div",{className:"flex justify-between items-center",children:[(0,t.jsxs)("div",{children:[(0,t.jsxs)("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[(0,t.jsx)(r.Z,{className:"h-8 w-8"}),"Data Dictionary Manager"]}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"Manage database schemas for MSSQL and PostgreSQL databases by RNI version"})]}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsxs)(I.Dialog,{open:$,onOpenChange:ee,children:[(0,t.jsx)(I.DialogTrigger,{asChild:!0,children:(0,t.jsxs)(v.z,{children:[(0,t.jsx)(i.Z,{className:"h-4 w-4 mr-2"}),"Upload Schema"]})}),(0,t.jsxs)(I.DialogContent,{className:"max-w-2xl",children:[(0,t.jsxs)(I.DialogHeader,{children:[(0,t.jsx)(I.DialogTitle,{children:"Upload Database Schema"}),(0,t.jsx)(I.DialogDescription,{children:"Upload schema data for Sensus AMI databases. You'll need to run the provided SQL query on your database and upload the CSV results."})]}),(0,t.jsxs)("div",{className:"grid gap-4 py-4",children:[(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(F,{htmlFor:"rni_version",children:"RNI Version"}),(0,t.jsxs)(S,{value:et.rni_version_id.toString(),onValueChange:e=>en(a=>({...a,rni_version_id:parseInt(e)})),children:[(0,t.jsx)(C,{children:(0,t.jsx)(k,{placeholder:"Select RNI Version"})}),(0,t.jsx)(A,{children:e.map(e=>(0,t.jsxs)(D,{value:e.id.toString(),children:[e.version_number," - ",e.version_name]},e.id))})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(F,{htmlFor:"database_type",children:"Database Type"}),(0,t.jsxs)(S,{value:et.database_type,onValueChange:e=>en(a=>({...a,database_type:e})),children:[(0,t.jsx)(C,{children:(0,t.jsx)(k,{})}),(0,t.jsxs)(A,{children:[(0,t.jsx)(D,{value:"PostgreSQL",children:"PostgreSQL"}),(0,t.jsx)(D,{value:"MSSQL",children:"Microsoft SQL Server"})]})]})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(F,{htmlFor:"database_name",children:"Database Name"}),(0,t.jsx)(_,{id:"database_name",value:et.database_name,onChange:e=>en(a=>({...a,database_name:e.target.value})),placeholder:"e.g., FlexnetDB, AMDS, Router, FWDL"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(F,{htmlFor:"schema_file",children:"Schema CSV File"}),(0,t.jsx)(_,{id:"schema_file",type:"file",accept:".csv",onChange:e=>{var a;return es((null===(a=e.target.files)||void 0===a?void 0:a[0])||null)},className:"cursor-pointer"}),(0,t.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:"Upload a CSV file generated by running the extraction query on your database. See the query help section below."})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(F,{htmlFor:"created_by",children:"Created By"}),(0,t.jsx)(_,{id:"created_by",value:et.created_by,onChange:e=>en(a=>({...a,created_by:e.target.value})),placeholder:"Your name or username"})]}),(0,t.jsxs)("div",{className:"border rounded-lg p-4 bg-amber-50 border-amber-200",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,t.jsx)("h4",{className:"font-medium text-amber-800",children:"\uD83D\uDCCB Schema Extraction Query"}),(0,t.jsxs)(v.z,{type:"button",variant:"outline",onClick:()=>ei(!er),className:"text-xs",children:[er?"Hide":"Show"," Query"]})]}),er&&(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("p",{className:"text-sm text-amber-700",children:[(0,t.jsx)("strong",{children:"⚠️ Important:"})," You must run this query on your ",et.database_type," database to generate the CSV file for upload:"]}),(0,t.jsxs)("div",{className:"relative bg-gray-900 text-gray-100 p-3 rounded text-xs font-mono overflow-x-auto",children:[(0,t.jsx)(v.z,{type:"button",variant:"outline",onClick:()=>eN("MSSQL"===et.database_type?H(et.database_name):M(et.database_name)),className:"absolute top-2 right-2 h-6 px-2 text-xs bg-gray-700 hover:bg-gray-600 border-gray-600",children:"\uD83D\uDCCB Copy"}),(0,t.jsx)("pre",{className:"whitespace-pre-wrap pr-16",children:"MSSQL"===et.database_type?H(et.database_name):M(et.database_name)})]}),(0,t.jsxs)("div",{className:"text-xs text-amber-700 bg-white p-3 rounded border",children:[(0,t.jsx)("p",{children:(0,t.jsx)("strong",{children:"\uD83D\uDCDD Step-by-step Instructions:"})}),(0,t.jsxs)("ol",{className:"list-decimal list-inside space-y-1 mt-2",children:[(0,t.jsx)("li",{children:"Copy the SQL query above"}),(0,t.jsxs)("li",{children:["Connect to your ",et.database_name," database"]}),(0,t.jsx)("li",{children:"Execute the query in your SQL client"}),(0,t.jsx)("li",{children:"Export the query results as a CSV file"}),(0,t.jsx)("li",{children:"Upload the generated CSV file using the file selector above"})]}),(0,t.jsxs)("p",{className:"mt-2 text-amber-600",children:[(0,t.jsx)("strong",{children:"Note:"})," This system cannot directly access your database servers. You must generate and upload the schema data manually."]})]})]})]})]}),(0,t.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,t.jsx)(v.z,{variant:"outline",onClick:()=>ee(!1),children:"Cancel"}),(0,t.jsx)(v.z,{onClick:ey,disabled:Z||!ea,children:Z?"Uploading...":"Upload Schema"})]})]})]}),(0,t.jsxs)(I.Dialog,{open:eo,onOpenChange:ed,children:[(0,t.jsx)(I.DialogTrigger,{asChild:!0,children:(0,t.jsxs)(v.z,{variant:"outline",children:[(0,t.jsx)(l.Z,{className:"h-4 w-4 mr-2"}),"Compare Versions"]})}),(0,t.jsxs)(I.DialogContent,{children:[(0,t.jsxs)(I.DialogHeader,{children:[(0,t.jsx)(I.DialogTitle,{children:"Compare Schema Versions"}),(0,t.jsx)(I.DialogDescription,{children:"Compare database schemas between two RNI versions"})]}),(0,t.jsxs)("div",{className:"grid gap-4 py-4",children:[(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(F,{htmlFor:"version1",children:"Version 1"}),(0,t.jsxs)(S,{value:eu,onValueChange:eh,children:[(0,t.jsx)(C,{children:(0,t.jsx)(k,{placeholder:"Select first version"})}),(0,t.jsx)(A,{children:e.map(e=>(0,t.jsx)(D,{value:e.version_number,children:e.version_number},e.id))})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(F,{htmlFor:"version2",children:"Version 2"}),(0,t.jsxs)(S,{value:em,onValueChange:ex,children:[(0,t.jsx)(C,{children:(0,t.jsx)(k,{placeholder:"Select second version"})}),(0,t.jsx)(A,{children:e.map(e=>(0,t.jsx)(D,{value:e.version_number,children:e.version_number},e.id))})]})]})]}),(0,t.jsx)(v.z,{onClick:e_,disabled:!eu||!em||Z,children:Z?"Comparing...":"Compare Schemas"}),ep&&(0,t.jsxs)("div",{className:"mt-4 space-y-2",children:[(0,t.jsx)("h4",{className:"font-medium",children:"Comparison Results:"}),(0,t.jsx)("div",{className:"max-h-60 overflow-y-auto",children:ep.changes.map((e,a)=>(0,t.jsxs)("div",{className:"flex items-center justify-between p-2 bg-muted rounded",children:[(0,t.jsxs)("span",{className:"text-sm",children:[e.schema_name,".",e.table_name,".",e.column_name]}),(0,t.jsx)(N.C,{variant:"ADDED"===e.change_type?"default":"REMOVED"===e.change_type?"destructive":"secondary",children:e.change_type})]},a))})]})]})]})]})]})]}),(0,t.jsxs)(b.Zb,{children:[(0,t.jsx)(b.Ol,{children:(0,t.jsxs)(b.ll,{className:"flex items-center gap-2",children:[(0,t.jsx)(c.Z,{className:"h-5 w-5"}),"Filters"]})}),(0,t.jsx)(b.aY,{children:(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(F,{children:"RNI Version"}),(0,t.jsxs)(S,{value:s,onValueChange:e=>{g(e),Y(""),G(""),T([]),X("")},children:[(0,t.jsx)(C,{children:(0,t.jsx)(k,{placeholder:"Select RNI Version"})}),(0,t.jsx)(A,{children:e.map(e=>(0,t.jsxs)(D,{value:e.version_number,children:[e.version_number,e.is_active&&(0,t.jsx)(N.C,{className:"ml-2",children:"Active"})]},e.id))})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(F,{children:"Database"}),(0,t.jsxs)(S,{value:W,onValueChange:e=>{Y(e),G("")},children:[(0,t.jsx)(C,{children:(0,t.jsx)(k,{placeholder:"All Databases"})}),(0,t.jsxs)(A,{children:[(0,t.jsx)(D,{value:"",children:"All Databases"}),eS.map(e=>(0,t.jsx)(D,{value:e,children:e},e))]})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(F,{children:"Schema"}),(0,t.jsxs)(S,{value:B,onValueChange:G,children:[(0,t.jsx)(C,{children:(0,t.jsx)(k,{placeholder:"All Schemas"})}),(0,t.jsxs)(A,{children:[(0,t.jsx)(D,{value:"",children:"All Schemas"}),eC.map(e=>(0,t.jsx)(D,{value:e,children:e},e))]})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(F,{children:"Search Tables"}),(0,t.jsx)(_,{placeholder:"Search tables...",value:z,onChange:e=>J(e.target.value)})]})]})})]}),(0,t.jsxs)(E,{defaultValue:"overview",className:"space-y-4",children:[(0,t.jsxs)(O,{children:[(0,t.jsx)(L,{value:"overview",children:"Schema Overview"}),(0,t.jsx)(L,{value:"columns",children:"Column Details"}),(0,t.jsx)(L,{value:"instances",children:"Database Instances"}),(0,t.jsx)(L,{value:"ami-assistant",children:"Technical Services Assistant"})]}),(0,t.jsx)(R,{value:"overview",children:(0,t.jsxs)(b.Zb,{children:[(0,t.jsx)(b.Ol,{children:(0,t.jsxs)(b.ll,{className:"flex items-center justify-between",children:[(0,t.jsxs)("span",{className:"flex items-center gap-2",children:[(0,t.jsx)(o.Z,{className:"h-5 w-5"}),"Schema Overview (",ew.length," tables)"]}),(0,t.jsxs)(v.z,{variant:"outline",size:"sm",children:[(0,t.jsx)(d.Z,{className:"h-4 w-4 mr-2"}),"Export"]})]})}),(0,t.jsx)(b.aY,{children:Z?(0,t.jsxs)("div",{className:"flex items-center justify-center py-8",children:[(0,t.jsx)(u.Z,{className:"h-6 w-6 animate-spin mr-2"}),"Loading schema data..."]}):(0,t.jsx)("div",{className:"overflow-x-auto",children:(0,t.jsxs)("table",{className:"w-full border-collapse",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{className:"border-b",children:[(0,t.jsx)("th",{className:"text-left p-2",children:"Database"}),(0,t.jsx)("th",{className:"text-left p-2",children:"Schema"}),(0,t.jsx)("th",{className:"text-left p-2",children:"Table"}),(0,t.jsx)("th",{className:"text-left p-2",children:"Type"}),(0,t.jsx)("th",{className:"text-left p-2",children:"Columns"}),(0,t.jsx)("th",{className:"text-left p-2",children:"Rows"}),(0,t.jsx)("th",{className:"text-left p-2",children:"Actions"})]})}),(0,t.jsx)("tbody",{children:ew.map((e,a)=>(0,t.jsxs)("tr",{className:"border-b hover:bg-muted/50",children:[(0,t.jsx)("td",{className:"p-2",children:(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)(r.Z,{className:"h-4 w-4"}),e.database_name,(0,t.jsx)(N.C,{variant:"outline",children:e.database_type})]})}),(0,t.jsx)("td",{className:"p-2",children:e.schema_name}),(0,t.jsx)("td",{className:"p-2",children:(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{className:"font-medium",children:e.table_name}),e.table_description&&(0,t.jsx)("div",{className:"text-xs text-muted-foreground",children:e.table_description})]})}),(0,t.jsx)("td",{className:"p-2",children:(0,t.jsx)(N.C,{variant:"TABLE"===e.table_type?"default":"secondary",children:e.table_type})}),(0,t.jsx)("td",{className:"p-2",children:e.column_count}),(0,t.jsx)("td",{className:"p-2",children:null!==e.row_count?e.row_count.toLocaleString():"N/A"}),(0,t.jsx)("td",{className:"p-2",children:(0,t.jsx)(v.z,{variant:"ghost",size:"sm",onClick:()=>eb(e.table_name),children:(0,t.jsx)(h.Z,{className:"h-4 w-4"})})})]},a))})]})})})]})}),(0,t.jsx)(R,{value:"columns",children:(0,t.jsxs)(b.Zb,{children:[(0,t.jsx)(b.Ol,{children:(0,t.jsxs)(b.ll,{className:"flex items-center gap-2",children:[(0,t.jsx)(m.Z,{className:"h-5 w-5"}),"Column Details",K&&(0,t.jsxs)("span",{className:"text-muted-foreground",children:["- ",K]})]})}),(0,t.jsx)(b.aY,{children:w.length>0?(0,t.jsx)("div",{className:"overflow-x-auto",children:(0,t.jsxs)("table",{className:"w-full border-collapse",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{className:"border-b",children:[(0,t.jsx)("th",{className:"text-left p-2",children:"#"}),(0,t.jsx)("th",{className:"text-left p-2",children:"Column Name"}),(0,t.jsx)("th",{className:"text-left p-2",children:"Data Type"}),(0,t.jsx)("th",{className:"text-left p-2",children:"Nullable"}),(0,t.jsx)("th",{className:"text-left p-2",children:"Key"}),(0,t.jsx)("th",{className:"text-left p-2",children:"Default"}),(0,t.jsx)("th",{className:"text-left p-2",children:"Description"})]})}),(0,t.jsx)("tbody",{children:w.map((e,a)=>(0,t.jsxs)("tr",{className:"border-b hover:bg-muted/50",children:[(0,t.jsx)("td",{className:"p-2",children:e.ordinal_position}),(0,t.jsx)("td",{className:"p-2 font-medium",children:e.column_name}),(0,t.jsx)("td",{className:"p-2",children:(0,t.jsxs)("code",{className:"text-sm bg-muted px-1 rounded",children:[e.data_type,e.max_length&&"(".concat(e.max_length,")"),e.precision_value&&e.scale_value&&"(".concat(e.precision_value,",").concat(e.scale_value,")")]})}),(0,t.jsx)("td",{className:"p-2",children:e.is_nullable?(0,t.jsx)(x.Z,{className:"h-4 w-4 text-green-500"}):(0,t.jsx)(p.Z,{className:"h-4 w-4 text-red-500"})}),(0,t.jsx)("td",{className:"p-2",children:(0,t.jsxs)("div",{className:"flex gap-1",children:[e.is_primary_key&&(0,t.jsx)(N.C,{children:"PK"}),e.is_foreign_key&&(0,t.jsx)(N.C,{variant:"outline",children:"FK"}),e.is_identity&&(0,t.jsx)(N.C,{variant:"secondary",children:"ID"})]})}),(0,t.jsx)("td",{className:"p-2 text-sm text-muted-foreground",children:e.default_value||"-"}),(0,t.jsx)("td",{className:"p-2 text-sm text-muted-foreground",children:e.description||"-"})]},a))})]})}):(0,t.jsx)("div",{className:"text-center py-8 text-muted-foreground",children:"Select a table from the Schema Overview to view column details"})})]})}),(0,t.jsx)(R,{value:"instances",children:(0,t.jsxs)(b.Zb,{children:[(0,t.jsx)(b.Ol,{children:(0,t.jsxs)(b.ll,{className:"flex items-center gap-2",children:[(0,t.jsx)(f.Z,{className:"h-5 w-5"}),"Database Instances"]})}),(0,t.jsx)(b.aY,{children:(0,t.jsx)("div",{className:"grid gap-4",children:P.map(e=>(0,t.jsx)(b.Zb,{className:"p-4",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{children:[(0,t.jsxs)("h3",{className:"font-medium flex items-center gap-2",children:[(0,t.jsx)(r.Z,{className:"h-4 w-4"}),e.database_name,(0,t.jsx)(N.C,{variant:"outline",children:e.database_type}),e.is_active&&(0,t.jsx)(N.C,{children:"Active"})]}),(0,t.jsxs)("p",{className:"text-sm text-muted-foreground",children:[e.server_name,":",e.port]}),e.description&&(0,t.jsx)("p",{className:"text-sm text-muted-foreground mt-1",children:e.description})]}),(0,t.jsx)("div",{className:"flex gap-2",children:(0,t.jsx)(v.z,{variant:"outline",size:"sm",children:(0,t.jsx)(f.Z,{className:"h-4 w-4"})})})]})},e.id))})})]})}),(0,t.jsx)(R,{value:"ami-assistant",children:(0,t.jsx)(Q,{buildHeaders:ec,accessToken:el})})]})]})}function H(e){return"-- Sensus AMI ".concat(e," Schema Extraction Query (MSSQL)\n-- Run this query to extract schema information for data dictionary import\n\nSELECT\n    s.name AS schema_name,\n    t.name AS table_name,\n    c.name AS column_name,\n    ty.name AS data_type,\n    c.max_length,\n    c.precision,\n    c.scale,\n    c.is_nullable,\n    c.is_identity,\n    CASE WHEN pk.column_name IS NOT NULL THEN 1 ELSE 0 END AS is_primary_key,\n    ISNULL(cc.definition, '') AS default_value,\n    ISNULL(ep.value, '') AS column_description\nFROM sys.tables t\nINNER JOIN sys.schemas s ON t.schema_id = s.schema_id\nINNER JOIN sys.columns c ON t.object_id = c.object_id\nINNER JOIN sys.types ty ON c.user_type_id = ty.user_type_id\nLEFT JOIN (\n    SELECT\n        ic.object_id,\n        ic.column_id,\n        c.name AS column_name\n    FROM sys.indexes i\n    INNER JOIN sys.index_columns ic ON i.object_id = ic.object_id AND i.index_id = ic.index_id\n    INNER JOIN sys.columns c ON ic.object_id = c.object_id AND ic.column_id = c.column_id\n    WHERE i.is_primary_key = 1\n) pk ON t.object_id = pk.object_id AND c.column_id = pk.column_id\nLEFT JOIN sys.default_constraints cc ON c.default_object_id = cc.object_id\nLEFT JOIN sys.extended_properties ep ON t.object_id = ep.major_id AND c.column_id = ep.minor_id AND ep.name = 'MS_Description'\nWHERE t.type = 'U'  -- User tables only\nORDER BY s.name, t.name, c.column_id;")}function M(e){return"-- Sensus AMI ".concat(e," Schema Extraction Query (PostgreSQL)\n-- Run this query to extract schema information for data dictionary import\n\nSELECT\n    n.nspname AS schema_name,\n    c.relname AS table_name,\n    a.attname AS column_name,\n    t.typname AS data_type,\n    CASE WHEN a.attlen > 0 THEN a.attlen ELSE a.atttypmod - 4 END AS max_length,\n    0 AS precision,  -- PostgreSQL specific handling would go here\n    0 AS scale,      -- PostgreSQL specific handling would go here\n    NOT a.attnotnull AS is_nullable,\n    CASE WHEN a.attidentity != '' THEN true ELSE false END AS is_identity,\n    CASE WHEN pk.attname IS NOT NULL THEN true ELSE false END AS is_primary_key,\n    COALESCE(ad.adsrc, '') AS default_value,\n    COALESCE(d.description, '') AS column_description\nFROM pg_class c\nJOIN pg_namespace n ON c.relnamespace = n.oid\nJOIN pg_attribute a ON c.oid = a.attrelid\nJOIN pg_type t ON a.atttypid = t.oid\nLEFT JOIN pg_attrdef ad ON a.attrelid = ad.adrelid AND a.attnum = ad.adnum\nLEFT JOIN pg_description d ON c.oid = d.objoid AND a.attnum = d.objsubid\nLEFT JOIN (\n    SELECT\n        i.indrelid,\n        a.attname,\n        a.attnum\n    FROM pg_index i\n    JOIN pg_attribute a ON i.indrelid = a.attrelid AND a.attnum = ANY(i.indkey)\n    WHERE i.indisprimary = true\n) pk ON c.oid = pk.indrelid AND a.attnum = pk.attnum\nWHERE c.relkind = 'r'  -- Regular tables only\n  AND n.nspname NOT IN ('information_schema', 'pg_catalog', 'pg_toast')\n  AND a.attnum > 0     -- Exclude system columns\n  AND NOT a.attisdropped\nORDER BY n.nspname, c.relname, a.attnum;")}function Q(e){var a;let{buildHeaders:s,accessToken:r}=e,[i,l]=(0,n.useState)(""),[c,o]=(0,n.useState)(""),[d,h]=(0,n.useState)(null),[m,f]=(0,n.useState)(!1),[y,_]=(0,n.useState)([]);(0,n.useEffect)(()=>{r&&(async()=>{try{let e=await fetch("/api/data-dictionary/rni-versions",{headers:s()}),a=await e.json();_(a)}catch(e){console.error("Failed to load RNI versions:",e)}})()},[r,s]);let w=async()=>{if(!i||!c){alert("Please select both RNI version and database name");return}if(!r){alert("Please sign in again to continue.");return}f(!0);try{let e=await fetch("/api/data-dictionary/query-assistance",{method:"POST",headers:s({"Content-Type":"application/json"}),body:JSON.stringify({rni_version:i,database_name:c})}),a=await e.json();h(a)}catch(e){console.error("Query assistance failed:",e),h({status:"error",message:"Failed to get query assistance"})}finally{f(!1)}},T=e=>{navigator.clipboard.writeText(e),alert("Copied to clipboard!")};return(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)(b.Zb,{children:[(0,t.jsxs)(b.Ol,{children:[(0,t.jsxs)(b.ll,{className:"flex items-center gap-2",children:[(0,t.jsx)(g.Z,{className:"h-5 w-5"}),"Technical Services Assistant"]}),(0,t.jsx)(b.SZ,{children:"Get help with database queries for Sensus AMI Infrastructure. Check if schema data is available or get SQL queries to extract schema information for upload."})]}),(0,t.jsxs)(b.aY,{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(F,{htmlFor:"rni-version",children:"RNI Version *"}),(0,t.jsxs)(S,{value:i,onValueChange:l,children:[(0,t.jsx)(C,{children:(0,t.jsx)(k,{placeholder:"Select RNI version"})}),(0,t.jsx)(A,{children:y.map(e=>(0,t.jsxs)(D,{value:e.version_number,children:[e.version_number," - ",e.version_name,e.is_active&&(0,t.jsx)(N.C,{className:"ml-2",children:"Active"})]},e.id))})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(F,{htmlFor:"database-name",children:"Database Name *"}),(0,t.jsxs)(S,{value:c,onValueChange:o,children:[(0,t.jsx)(C,{children:(0,t.jsx)(k,{placeholder:"Select database"})}),(0,t.jsxs)(A,{children:[(0,t.jsx)(D,{value:"FlexnetDB",children:"FlexnetDB (MSSQL)"}),(0,t.jsx)(D,{value:"AMDS",children:"AMDS (PostgreSQL)"}),(0,t.jsx)(D,{value:"Router",children:"Router (PostgreSQL)"}),(0,t.jsx)(D,{value:"FWDL",children:"FWDL (PostgreSQL)"})]})]})]})]}),(0,t.jsx)(v.z,{onClick:w,disabled:m||!i||!c,className:"w-full",children:m?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(u.Z,{className:"h-4 w-4 mr-2 animate-spin"}),"Checking Data Dictionary..."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(g.Z,{className:"h-4 w-4 mr-2"}),"Get Query Assistance"]})})]})]}),d&&(0,t.jsxs)(b.Zb,{children:[(0,t.jsx)(b.Ol,{children:(0,t.jsxs)(b.ll,{className:"flex items-center gap-2",children:["data_dictionary_available"===d.status&&(0,t.jsx)(x.Z,{className:"h-5 w-5 text-green-500"}),"schema_extraction_needed"===d.status&&(0,t.jsx)(j.Z,{className:"h-5 w-5 text-yellow-500"}),"database_not_configured"===d.status&&(0,t.jsx)(p.Z,{className:"h-5 w-5 text-red-500"}),"rni_version_not_found"===d.status&&(0,t.jsx)(p.Z,{className:"h-5 w-5 text-red-500"}),"Query Assistance Result"]})}),(0,t.jsxs)(b.aY,{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"p-4 bg-gray-50 rounded-lg",children:[(0,t.jsxs)("p",{className:"font-medium",children:["Status: ",null===(a=d.status)||void 0===a?void 0:a.replace("_"," ")]}),(0,t.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:d.message})]}),"data_dictionary_available"===d.status&&d.schemas_available&&(0,t.jsxs)("div",{children:[(0,t.jsx)("h4",{className:"font-medium mb-2",children:"Available Schemas:"}),(0,t.jsx)("div",{className:"space-y-2",children:d.schemas_available.map((e,a)=>(0,t.jsxs)("div",{className:"flex items-center justify-between p-2 bg-green-50 rounded",children:[(0,t.jsx)("span",{className:"font-medium",children:e.schema_name}),(0,t.jsxs)(N.C,{variant:"secondary",children:[e.table_count," tables"]})]},a))}),(0,t.jsx)("p",{className:"text-sm text-gray-600 mt-2",children:"Data dictionary is available. You can proceed with your queries using the schema information."})]}),"schema_extraction_needed"===d.status&&d.extraction_query&&(0,t.jsxs)("div",{children:[(0,t.jsx)("h4",{className:"font-medium mb-2",children:"Schema Extraction Required"}),(0,t.jsxs)("p",{className:"text-sm text-gray-600 mb-3",children:["No schema information is available. Run the following query on your ",d.database_type," database to extract the schema:"]}),(0,t.jsxs)("div",{className:"bg-gray-900 text-gray-100 p-4 rounded-lg text-sm font-mono overflow-x-auto",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,t.jsxs)("span",{className:"text-gray-400",children:["Extraction Query (",d.database_type,")"]}),(0,t.jsx)(v.z,{variant:"outline",onClick:()=>T(d.extraction_query),className:"h-6 px-2 text-xs",children:"Copy"})]}),(0,t.jsx)("pre",{className:"whitespace-pre-wrap",children:d.extraction_query})]}),(0,t.jsxs)("div",{className:"mt-3 p-3 bg-blue-50 border border-blue-200 rounded",children:[(0,t.jsx)("h5",{className:"font-medium text-blue-800",children:"Next Steps:"}),(0,t.jsxs)("ol",{className:"list-decimal list-inside text-sm text-blue-700 mt-1 space-y-1",children:[(0,t.jsx)("li",{children:"Copy the extraction query above"}),(0,t.jsxs)("li",{children:["Connect to your ",c," database server"]}),(0,t.jsx)("li",{children:"Execute the query in your SQL client"}),(0,t.jsx)("li",{children:"Export the results as a CSV file"}),(0,t.jsx)("li",{children:'Upload the CSV file using the "Upload Schema" button'})]}),(0,t.jsxs)("p",{className:"text-xs text-blue-600 mt-2",children:[(0,t.jsx)("strong",{children:"Note:"})," The system cannot access your database servers directly. You must run the query and upload the results manually."]})]})]}),"database_not_configured"===d.status&&(0,t.jsxs)("div",{className:"p-3 bg-orange-50 border border-orange-200 rounded",children:[(0,t.jsx)("h5",{className:"font-medium text-orange-800",children:"Database Not Configured"}),(0,t.jsxs)("p",{className:"text-sm text-orange-700 mt-1",children:["The database ",c," is not configured for RNI version ",i,'. Please add it using the "Database Instances" tab first.']})]}),"rni_version_not_found"===d.status&&(0,t.jsxs)("div",{className:"p-3 bg-red-50 border border-red-200 rounded",children:[(0,t.jsx)("h5",{className:"font-medium text-red-800",children:"RNI Version Not Found"}),(0,t.jsxs)("p",{className:"text-sm text-red-700 mt-1",children:["RNI version ",i," was not found. Please check available versions in the dropdown."]})]})]})]}),(0,t.jsxs)(b.Zb,{children:[(0,t.jsx)(b.Ol,{children:(0,t.jsx)(b.ll,{className:"text-lg",children:"Sensus AMI Databases"})}),(0,t.jsx)(b.aY,{children:(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{className:"p-4 border rounded-lg",children:[(0,t.jsx)("h4",{className:"font-semibold text-blue-600",children:"FlexnetDB (Microsoft SQL Server)"}),(0,t.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:"Primary Sensus AMI database containing meter data, billing information, and infrastructure management."})]}),(0,t.jsxs)("div",{className:"p-4 border rounded-lg",children:[(0,t.jsx)("h4",{className:"font-semibold text-green-600",children:"AMDS (PostgreSQL)"}),(0,t.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:"Advanced Metering Data System for real-time meter reading and data processing."})]}),(0,t.jsxs)("div",{className:"p-4 border rounded-lg",children:[(0,t.jsx)("h4",{className:"font-semibold text-green-600",children:"Router (PostgreSQL)"}),(0,t.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:"Communication management database for AMI network routing and device connectivity."})]}),(0,t.jsxs)("div",{className:"p-4 border rounded-lg",children:[(0,t.jsx)("h4",{className:"font-semibold text-green-600",children:"FWDL (PostgreSQL)"}),(0,t.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:"Firmware Download management system for device updates and version control."})]})]})})]})]})}},5974:function(e,a,s){"use strict";s.d(a,{C:function(){return l}});var t=s(7437);s(2265);var n=s(535),r=s(4508);let i=(0,n.j)("inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground shadow hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function l(e){let{className:a,variant:s,...n}=e;return(0,t.jsx)("div",{className:(0,r.cn)(i({variant:s}),a),...n})}},2869:function(e,a,s){"use strict";s.d(a,{z:function(){return o}});var t=s(7437),n=s(2265),r=s(7495),i=s(535),l=s(4508);let c=(0,i.j)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground shadow hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",outline:"border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2",sm:"h-8 rounded-md px-3 text-xs",lg:"h-10 rounded-md px-8",icon:"h-9 w-9"}},defaultVariants:{variant:"default",size:"default"}}),o=n.forwardRef((e,a)=>{let{className:s,variant:n,size:i,asChild:o=!1,...d}=e,u=o?r.g7:"button";return(0,t.jsx)(u,{className:(0,l.cn)(c({variant:n,size:i,className:s})),ref:a,...d})});o.displayName="Button"},6070:function(e,a,s){"use strict";s.d(a,{Ol:function(){return l},SZ:function(){return o},Zb:function(){return i},aY:function(){return d},ll:function(){return c}});var t=s(7437),n=s(2265),r=s(4508);let i=n.forwardRef((e,a)=>{let{className:s,...n}=e;return(0,t.jsx)("div",{ref:a,className:(0,r.cn)("rounded-xl border bg-card text-card-foreground shadow",s),...n})});i.displayName="Card";let l=n.forwardRef((e,a)=>{let{className:s,...n}=e;return(0,t.jsx)("div",{ref:a,className:(0,r.cn)("flex flex-col space-y-1.5 p-6",s),...n})});l.displayName="CardHeader";let c=n.forwardRef((e,a)=>{let{className:s,...n}=e;return(0,t.jsx)("div",{ref:a,className:(0,r.cn)("font-semibold leading-none tracking-tight",s),...n})});c.displayName="CardTitle";let o=n.forwardRef((e,a)=>{let{className:s,...n}=e;return(0,t.jsx)("div",{ref:a,className:(0,r.cn)("text-sm text-muted-foreground",s),...n})});o.displayName="CardDescription";let d=n.forwardRef((e,a)=>{let{className:s,...n}=e;return(0,t.jsx)("div",{ref:a,className:(0,r.cn)("p-6 pt-0",s),...n})});d.displayName="CardContent",n.forwardRef((e,a)=>{let{className:s,...n}=e;return(0,t.jsx)("div",{ref:a,className:(0,r.cn)("flex items-center p-6 pt-0",s),...n})}).displayName="CardFooter"},6110:function(e,a,s){"use strict";s.r(a),s.d(a,{Dialog:function(){return l},DialogContent:function(){return h},DialogDescription:function(){return p},DialogHeader:function(){return m},DialogTitle:function(){return x},DialogTrigger:function(){return u}});var t=s(7437),n=s(2265),r=s(2489),i=s(2869);let l=e=>{let{open:a,onOpenChange:s,children:r}=e,[i,l]=n.useState(a||!1);return n.useEffect(()=>{void 0!==a&&l(a)},[a]),(0,t.jsx)(o,{value:{open:i,onOpenChange:e=>{l(e),null==s||s(e)}},children:r})},c=n.createContext(null),o=c.Provider,d=()=>{let e=n.useContext(c);if(!e)throw Error("useDialog must be used within Dialog");return e},u=e=>{let{asChild:a,children:s}=e,{open:r,onOpenChange:l}=d(),c=()=>{l(!r)};return a?n.cloneElement(s,{onClick:c}):(0,t.jsx)(i.z,{onClick:c,children:s})},h=e=>{let{className:a="",children:s}=e,{open:n,onOpenChange:l}=d();return n?(0,t.jsxs)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center",children:[(0,t.jsx)("div",{className:"fixed inset-0 bg-black/60",style:{zIndex:9998},onClick:()=>l(!1)}),(0,t.jsxs)("div",{className:"relative bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-xl mx-4",style:{zIndex:9999},children:[(0,t.jsx)(i.z,{variant:"ghost",size:"sm",className:"absolute right-2 top-2 p-1 h-6 w-6",onClick:()=>l(!1),children:(0,t.jsx)(r.Z,{className:"h-4 w-4"})}),s]})]}):null},m=e=>{let{children:a}=e;return(0,t.jsx)("div",{className:"mb-4",children:a})},x=e=>{let{children:a}=e;return(0,t.jsx)("h2",{className:"text-lg font-semibold",children:a})},p=e=>{let{children:a}=e;return(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:a})}},4508:function(e,a,s){"use strict";s.d(a,{G:function(){return i},cn:function(){return r}});var t=s(1994),n=s(3335);function r(){for(var e=arguments.length,a=Array(e),s=0;s<e;s++)a[s]=arguments[s];return(0,n.m6)((0,t.W)(a))}function i(e){return e}},1245:function(e,a,s){"use strict";s.d(a,{AuthProvider:function(){return c},a:function(){return o}});var t=s(7437),n=s(2265);let r=(0,n.createContext)(void 0),i="tsa_auth_v1";function l(e){try{localStorage.setItem(i,JSON.stringify(e))}catch(e){}}let c=e=>{let{children:a}=e,[s,c]=(0,n.useState)({user:null,accessToken:null,refreshToken:null,expiresAt:null,loading:!0,error:null}),o=e=>c(a=>({...a,...e})),d=e=>e;(0,n.useEffect)(()=>{let e=!1;return(async()=>{console.log("[AUTH] Initializing auth context");let a=function(){try{let e=localStorage.getItem(i);if(!e)return null;return JSON.parse(e)}catch(e){return null}}();if(console.log("[AUTH] Persisted state:",a?"Found tokens":"No tokens"),!(null==a?void 0:a.accessToken)){console.log("[AUTH] No access token found, setting loading false"),e||o({loading:!1});return}console.log("[AUTH] Found access token, loading user profile"),o({...a,loading:!0});try{let a=await fetch(d("/api/auth/health")).catch(()=>null);if(!a||!a.ok&&404!==a.status){e||o({loading:!1,error:"Auth service unavailable"});return}}catch(a){e||o({loading:!1,error:"Auth service unavailable"});return}try{console.log("[AUTH] Fetching user profile from /api/auth/me");let s=await fetch(d("/api/auth/me"),{headers:{Authorization:"Bearer ".concat(a.accessToken)}});if(console.log("[AUTH] Profile fetch response status:",s.status),s.ok){let a=await s.json();console.log("[AUTH] Profile loaded:",{id:a.id,email:a.email,password_change_required:a.password_change_required}),e||o({user:a,loading:!1})}else e||(o({loading:!1,accessToken:null,refreshToken:null,user:null}),l({}))}catch(a){e||o({loading:!1})}})(),()=>{e=!0}},[]);let u=(0,n.useCallback)(async(e,a)=>{console.log("[AUTH] Login attempt for:",e),o({loading:!0,error:null});try{var s;console.log("[AUTH] Sending login request to:",d("/api/auth/login"));let t=await fetch(d("/api/auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:a})});if(console.log("[AUTH] Login response status:",t.status),!t.ok){let e="Login failed";try{let a=await t.json();a&&"string"==typeof a.detail&&(e=a.detail)}catch(e){}return o({loading:!1,error:e}),!1}let n=null;try{n=await t.json()}catch(e){return o({loading:!1,error:"Malformed server response"}),!1}if(console.log("[AUTH] Login response data:",{hasAccessToken:!!n.access_token,hasRefreshToken:!!n.refresh_token,hasUser:!!n.user,userPasswordChangeRequired:null===(s=n.user)||void 0===s?void 0:s.password_change_required}),!n||"object"!=typeof n||!n.access_token||!n.refresh_token||"number"!=typeof n.expires_in||!n.user)return console.log("[AUTH] Invalid login response data"),o({loading:!1,error:"Unexpected auth response"}),!1;let r=Number.isFinite(n.expires_in)?n.expires_in:0,i=Date.now()+Math.max(0,1e3*r-5e3),c={accessToken:n.access_token,refreshToken:n.refresh_token,expiresAt:i,user:n.user};return console.log("[AUTH] Login successful, setting user state:",{email:n.user.email,password_change_required:n.user.password_change_required}),o({...c,loading:!1}),l(c),!0}catch(e){return o({loading:!1,error:"Network error"}),!1}},[]),h=(0,n.useCallback)(async e=>{o({loading:!0,error:null});try{let a=await fetch(d("/api/auth/register"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...e,role_id:e.role_id||2})});if(!a.ok){let e=(await a.json().catch(()=>({}))).detail||"Registration failed";return o({loading:!1,error:e}),!1}return o({loading:!1}),!0}catch(e){return o({loading:!1,error:"Network error"}),!1}},[]),m=(0,n.useCallback)(()=>{if(o({user:null,accessToken:null,refreshToken:null,expiresAt:null}),l({}),!window.location.pathname.startsWith("/login"))try{window.location.href="/login"}catch(e){}},[]);(0,n.useEffect)(()=>{if(globalThis._tsaFetchWrapped)return;let e=fetch;globalThis._tsaFetchWrapped=!0,globalThis.fetch=async function(){for(var a=arguments.length,s=Array(a),t=0;t<a;t++)s[t]=arguments[t];let n=await e(...s);if(401===n.status){let e="string"==typeof s[0]?s[0]:s[0].url;if(!e.includes("/api/auth/login")&&!e.includes("/api/auth/register")&&(m(),!window.location.pathname.startsWith("/login")))try{window.location.pathname="/login"}catch(e){}}return n}},[m]);let x=(0,n.useCallback)(async()=>{if(console.log("[AUTH] Refresh called"),!s.refreshToken){console.log("[AUTH] No refresh token available");return}if(x._inFlight){console.log("[AUTH] Refresh already in flight");return}console.log("[AUTH] Starting token refresh"),x._inFlight=!0;try{var e,a;let t=await fetch(d("/api/auth/refresh"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:s.refreshToken})});if(console.log("[AUTH] Refresh response status:",t.status),!t.ok)return console.log("[AUTH] Refresh failed, logging out"),m();let n=await t.json();console.log("[AUTH] Refresh successful, updated user:",{email:null===(e=n.user)||void 0===e?void 0:e.email,password_change_required:null===(a=n.user)||void 0===a?void 0:a.password_change_required});let r=1e3*n.expires_in,i=Date.now()+r-Math.min(5e3,Math.max(1e3,.08*r)),c={accessToken:n.access_token,expiresAt:i,user:n.user};o(c),l({...c,refreshToken:s.refreshToken})}catch(e){m()}finally{x._inFlight=!1}},[s.refreshToken,m]);(0,n.useEffect)(()=>{if(!s.expiresAt)return;let e=s.expiresAt-Date.now();if(e<=0){x();return}let a=e-.12*e;a<1500&&(a=Math.min(Math.max(e-500,0),1500));let t=setTimeout(()=>x(),a);return()=>clearTimeout(t)},[s.expiresAt,x]);let p={...s,login:u,register:h,logout:m,refresh:x};return(0,t.jsx)(r.Provider,{value:p,children:a})};function o(){let e=(0,n.useContext)(r);if(!e)throw Error("useAuth must be used within AuthProvider");return e}}},function(e){e.O(0,[137,72,971,117,744],function(){return e(e.s=6008)}),_N_E=e.O()}]);