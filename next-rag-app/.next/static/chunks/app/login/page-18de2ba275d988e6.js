(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[626],{6367:function(e,r,t){Promise.resolve().then(t.bind(t,6374))},6374:function(e,r,t){"use strict";t.r(r),t.d(r,{default:function(){return u}});var n=t(7437),o=t(2265),l=t(7648),s=t(1245),a=t(2869),i=t(6070);function u(){let{login:e,loading:r,error:t,user:u}=(0,s.a)(),c=e=>{try{window.location.href=e}catch(e){}},[d,f]=(0,o.useState)(""),[g,h]=(0,o.useState)(""),[p,m]=(0,o.useState)(null);u&&(console.log("[LOGIN] User already logged in, redirecting to home:",u.email),c("/"));let v=async r=>{if(r.preventDefault(),console.log("[LOGIN] Form submitted for email:",d),m(null),!d||!g){console.log("[LOGIN] Missing email or password"),m("Email and password required");return}console.log("[LOGIN] Calling login function");let t=await e(d,g);console.log("[LOGIN] Login result:",t),t?(console.log("[LOGIN] Login successful, redirecting to home"),c("/")):console.log("[LOGIN] Login failed")};return(0,n.jsx)("div",{className:"flex items-center justify-center min-h-screen p-4",children:(0,n.jsxs)(i.Zb,{className:"p-8 w-full max-w-md space-y-6",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h1",{className:"text-2xl font-semibold mb-2",children:"Sign In"}),(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"Access the Technical Service Assistant"})]}),(0,n.jsxs)("form",{onSubmit:v,className:"space-y-4",children:[(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("label",{className:"text-sm font-medium",htmlFor:"login-email",children:"Email"}),(0,n.jsx)("input",{id:"login-email",type:"email",value:d,onChange:e=>f(e.target.value),className:"w-full border rounded px-3 py-2 text-sm bg-background",placeholder:"you@example.com",required:!0})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("label",{className:"text-sm font-medium",htmlFor:"login-password",children:"Password"}),(0,n.jsx)("input",{id:"login-password",type:"password",value:g,onChange:e=>h(e.target.value),className:"w-full border rounded px-3 py-2 text-sm bg-background",placeholder:"••••••••",required:!0})]}),(p||t)&&(0,n.jsx)("div",{className:"text-sm text-red-600",children:p||t}),(0,n.jsx)(a.z,{type:"submit",disabled:r,className:"w-full",children:r?"Signing in...":"Sign In"})]}),(0,n.jsxs)("div",{className:"text-sm text-center text-muted-foreground",children:["Need an account?"," ",(0,n.jsx)(l.default,{href:"/register",className:"text-primary underline",children:"Register"})]})]})})}},2869:function(e,r,t){"use strict";t.d(r,{z:function(){return u}});var n=t(7437),o=t(2265),l=t(7495),s=t(535),a=t(4508);let i=(0,s.j)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground shadow hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",outline:"border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2",sm:"h-8 rounded-md px-3 text-xs",lg:"h-10 rounded-md px-8",icon:"h-9 w-9"}},defaultVariants:{variant:"default",size:"default"}}),u=o.forwardRef((e,r)=>{let{className:t,variant:o,size:s,asChild:u=!1,...c}=e,d=u?l.g7:"button";return(0,n.jsx)(d,{className:(0,a.cn)(i({variant:o,size:s,className:t})),ref:r,...c})});u.displayName="Button"},6070:function(e,r,t){"use strict";t.d(r,{Ol:function(){return a},SZ:function(){return u},Zb:function(){return s},aY:function(){return c},ll:function(){return i}});var n=t(7437),o=t(2265),l=t(4508);let s=o.forwardRef((e,r)=>{let{className:t,...o}=e;return(0,n.jsx)("div",{ref:r,className:(0,l.cn)("rounded-xl border bg-card text-card-foreground shadow",t),...o})});s.displayName="Card";let a=o.forwardRef((e,r)=>{let{className:t,...o}=e;return(0,n.jsx)("div",{ref:r,className:(0,l.cn)("flex flex-col space-y-1.5 p-6",t),...o})});a.displayName="CardHeader";let i=o.forwardRef((e,r)=>{let{className:t,...o}=e;return(0,n.jsx)("div",{ref:r,className:(0,l.cn)("font-semibold leading-none tracking-tight",t),...o})});i.displayName="CardTitle";let u=o.forwardRef((e,r)=>{let{className:t,...o}=e;return(0,n.jsx)("div",{ref:r,className:(0,l.cn)("text-sm text-muted-foreground",t),...o})});u.displayName="CardDescription";let c=o.forwardRef((e,r)=>{let{className:t,...o}=e;return(0,n.jsx)("div",{ref:r,className:(0,l.cn)("p-6 pt-0",t),...o})});c.displayName="CardContent",o.forwardRef((e,r)=>{let{className:t,...o}=e;return(0,n.jsx)("div",{ref:r,className:(0,l.cn)("flex items-center p-6 pt-0",t),...o})}).displayName="CardFooter"},4508:function(e,r,t){"use strict";t.d(r,{G:function(){return s},cn:function(){return l}});var n=t(1994),o=t(3335);function l(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return(0,o.m6)((0,n.W)(r))}function s(e){return e}},1245:function(e,r,t){"use strict";t.d(r,{AuthProvider:function(){return i},a:function(){return u}});var n=t(7437),o=t(2265);let l=(0,o.createContext)(void 0),s="tsa_auth_v1";function a(e){try{localStorage.setItem(s,JSON.stringify(e))}catch(e){}}let i=e=>{let{children:r}=e,[t,i]=(0,o.useState)({user:null,accessToken:null,refreshToken:null,expiresAt:null,loading:!0,error:null}),u=e=>i(r=>({...r,...e})),c=e=>e;(0,o.useEffect)(()=>{let e=!1;return(async()=>{console.log("[AUTH] Initializing auth context");let r=function(){try{let e=localStorage.getItem(s);if(!e)return null;return JSON.parse(e)}catch(e){return null}}();if(console.log("[AUTH] Persisted state:",r?"Found tokens":"No tokens"),!(null==r?void 0:r.accessToken)){console.log("[AUTH] No access token found, setting loading false"),e||u({loading:!1});return}console.log("[AUTH] Found access token, loading user profile"),u({...r,loading:!0});try{let r=await fetch(c("/api/auth/health")).catch(()=>null);if(!r||!r.ok&&404!==r.status){e||u({loading:!1,error:"Auth service unavailable"});return}}catch(r){e||u({loading:!1,error:"Auth service unavailable"});return}try{console.log("[AUTH] Fetching user profile from /api/auth/me");let t=await fetch(c("/api/auth/me"),{headers:{Authorization:"Bearer ".concat(r.accessToken)}});if(console.log("[AUTH] Profile fetch response status:",t.status),t.ok){let r=await t.json();console.log("[AUTH] Profile loaded:",{id:r.id,email:r.email,password_change_required:r.password_change_required}),e||u({user:r,loading:!1})}else e||(u({loading:!1,accessToken:null,refreshToken:null,user:null}),a({}))}catch(r){e||u({loading:!1})}})(),()=>{e=!0}},[]);let d=(0,o.useCallback)(async(e,r)=>{console.log("[AUTH] Login attempt for:",e),u({loading:!0,error:null});try{var t;console.log("[AUTH] Sending login request to:",c("/api/auth/login"));let n=await fetch(c("/api/auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:r})});if(console.log("[AUTH] Login response status:",n.status),!n.ok){let e="Login failed";try{let r=await n.json();r&&"string"==typeof r.detail&&(e=r.detail)}catch(e){}return u({loading:!1,error:e}),!1}let o=null;try{o=await n.json()}catch(e){return u({loading:!1,error:"Malformed server response"}),!1}if(console.log("[AUTH] Login response data:",{hasAccessToken:!!o.access_token,hasRefreshToken:!!o.refresh_token,hasUser:!!o.user,userPasswordChangeRequired:null===(t=o.user)||void 0===t?void 0:t.password_change_required}),!o||"object"!=typeof o||!o.access_token||!o.refresh_token||"number"!=typeof o.expires_in||!o.user)return console.log("[AUTH] Invalid login response data"),u({loading:!1,error:"Unexpected auth response"}),!1;let l=Number.isFinite(o.expires_in)?o.expires_in:0,s=Date.now()+Math.max(0,1e3*l-5e3),i={accessToken:o.access_token,refreshToken:o.refresh_token,expiresAt:s,user:o.user};return console.log("[AUTH] Login successful, setting user state:",{email:o.user.email,password_change_required:o.user.password_change_required}),u({...i,loading:!1}),a(i),!0}catch(e){return u({loading:!1,error:"Network error"}),!1}},[]),f=(0,o.useCallback)(async e=>{u({loading:!0,error:null});try{let r=await fetch(c("/api/auth/register"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...e,role_id:e.role_id||2})});if(!r.ok){let e=(await r.json().catch(()=>({}))).detail||"Registration failed";return u({loading:!1,error:e}),!1}return u({loading:!1}),!0}catch(e){return u({loading:!1,error:"Network error"}),!1}},[]),g=(0,o.useCallback)(()=>{u({user:null,accessToken:null,refreshToken:null,expiresAt:null}),a({})},[]);(0,o.useEffect)(()=>{if(globalThis._tsaFetchWrapped)return;let e=fetch;globalThis._tsaFetchWrapped=!0,globalThis.fetch=async function(){for(var r=arguments.length,t=Array(r),n=0;n<r;n++)t[n]=arguments[n];let o=await e(...t);if(401===o.status){let e="string"==typeof t[0]?t[0]:t[0].url;if(!e.includes("/api/auth/login")&&!e.includes("/api/auth/register")&&(g(),!window.location.pathname.startsWith("/login")))try{window.location.pathname="/login"}catch(e){}}return o}},[g]);let h=(0,o.useCallback)(async()=>{if(console.log("[AUTH] Refresh called"),!t.refreshToken){console.log("[AUTH] No refresh token available");return}if(h._inFlight){console.log("[AUTH] Refresh already in flight");return}console.log("[AUTH] Starting token refresh"),h._inFlight=!0;try{var e,r;let n=await fetch(c("/api/auth/refresh"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:t.refreshToken})});if(console.log("[AUTH] Refresh response status:",n.status),!n.ok)return console.log("[AUTH] Refresh failed, logging out"),g();let o=await n.json();console.log("[AUTH] Refresh successful, updated user:",{email:null===(e=o.user)||void 0===e?void 0:e.email,password_change_required:null===(r=o.user)||void 0===r?void 0:r.password_change_required});let l=1e3*o.expires_in,s=Date.now()+l-Math.min(5e3,Math.max(1e3,.08*l)),i={accessToken:o.access_token,expiresAt:s,user:o.user};u(i),a({...i,refreshToken:t.refreshToken})}catch(e){g()}finally{h._inFlight=!1}},[t.refreshToken,g]);(0,o.useEffect)(()=>{if(!t.expiresAt)return;let e=t.expiresAt-Date.now();if(e<=0){h();return}let r=e-.12*e;r<1500&&(r=Math.min(Math.max(e-500,0),1500));let n=setTimeout(()=>h(),r);return()=>clearTimeout(n)},[t.expiresAt,h]);let p={...t,login:d,register:f,logout:g,refresh:h};return(0,n.jsx)(l.Provider,{value:p,children:r})};function u(){let e=(0,o.useContext)(l);if(!e)throw Error("useAuth must be used within AuthProvider");return e}},8575:function(e,r,t){"use strict";t.d(r,{F:function(){return l},e:function(){return s}});var n=t(2265);function o(e,r){if("function"==typeof e)return e(r);null!=e&&(e.current=r)}function l(...e){return r=>{let t=!1,n=e.map(e=>{let n=o(e,r);return t||"function"!=typeof n||(t=!0),n});if(t)return()=>{for(let r=0;r<n.length;r++){let t=n[r];"function"==typeof t?t():o(e[r],null)}}}}function s(...e){return n.useCallback(l(...e),e)}},7495:function(e,r,t){"use strict";t.d(r,{Z8:function(){return s},g7:function(){return a}});var n=t(2265),o=t(8575),l=t(7437);function s(e){let r=function(e){let r=n.forwardRef((e,r)=>{let{children:t,...l}=e;if(n.isValidElement(t)){let e,s;let a=(e=Object.getOwnPropertyDescriptor(t.props,"ref")?.get)&&"isReactWarning"in e&&e.isReactWarning?t.ref:(e=Object.getOwnPropertyDescriptor(t,"ref")?.get)&&"isReactWarning"in e&&e.isReactWarning?t.props.ref:t.props.ref||t.ref,i=function(e,r){let t={...r};for(let n in r){let o=e[n],l=r[n];/^on[A-Z]/.test(n)?o&&l?t[n]=(...e)=>{let r=l(...e);return o(...e),r}:o&&(t[n]=o):"style"===n?t[n]={...o,...l}:"className"===n&&(t[n]=[o,l].filter(Boolean).join(" "))}return{...e,...t}}(l,t.props);return t.type!==n.Fragment&&(i.ref=r?(0,o.F)(r,a):a),n.cloneElement(t,i)}return n.Children.count(t)>1?n.Children.only(null):null});return r.displayName=`${e}.SlotClone`,r}(e),t=n.forwardRef((e,t)=>{let{children:o,...s}=e,a=n.Children.toArray(o),i=a.find(u);if(i){let e=i.props.children,o=a.map(r=>r!==i?r:n.Children.count(e)>1?n.Children.only(null):n.isValidElement(e)?e.props.children:null);return(0,l.jsx)(r,{...s,ref:t,children:n.isValidElement(e)?n.cloneElement(e,void 0,o):null})}return(0,l.jsx)(r,{...s,ref:t,children:o})});return t.displayName=`${e}.Slot`,t}var a=s("Slot"),i=Symbol("radix.slottable");function u(e){return n.isValidElement(e)&&"function"==typeof e.type&&"__radixId"in e.type&&e.type.__radixId===i}},535:function(e,r,t){"use strict";t.d(r,{j:function(){return s}});var n=t(1994);let o=e=>"boolean"==typeof e?`${e}`:0===e?"0":e,l=n.W,s=(e,r)=>t=>{var n;if((null==r?void 0:r.variants)==null)return l(e,null==t?void 0:t.class,null==t?void 0:t.className);let{variants:s,defaultVariants:a}=r,i=Object.keys(s).map(e=>{let r=null==t?void 0:t[e],n=null==a?void 0:a[e];if(null===r)return null;let l=o(r)||o(n);return s[e][l]}),u=t&&Object.entries(t).reduce((e,r)=>{let[t,n]=r;return void 0===n||(e[t]=n),e},{});return l(e,i,null==r?void 0:null===(n=r.compoundVariants)||void 0===n?void 0:n.reduce((e,r)=>{let{class:t,className:n,...o}=r;return Object.entries(o).every(e=>{let[r,t]=e;return Array.isArray(t)?t.includes({...a,...u}[r]):({...a,...u})[r]===t})?[...e,t,n]:e},[]),null==t?void 0:t.class,null==t?void 0:t.className)}}},function(e){e.O(0,[137,648,971,117,744],function(){return e(e.s=6367)}),_N_E=e.O()}]);