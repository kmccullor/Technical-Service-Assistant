(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[973],{6456:function(e,t,r){Promise.resolve().then(r.bind(r,3334))},3334:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return l}});var a=r(7437),n=r(2265),s=r(1245),o=r(2869),i=r(6070);function l(){let{user:e,logout:t}=(0,s.a)(),[r,l]=(0,n.useState)(""),[c,d]=(0,n.useState)(""),[u,f]=(0,n.useState)(""),[h,p]=(0,n.useState)(!1),[m,g]=(0,n.useState)(null),[w,x]=(0,n.useState)(null),[y,b]=(0,n.useState)(!1);(0,n.useEffect)(()=>{(null==e?void 0:e.password_change_required)&&b(!0)},[e]);let v=e=>e.length<8?"Password must be at least 8 characters long":/[A-Z]/.test(e)?/[a-z]/.test(e)?/\d/.test(e)?/[!@#$%^&*(),.?":{}|<>]/.test(e)?null:"Password must contain at least one special character":"Password must contain at least one digit":"Password must contain at least one lowercase letter":"Password must contain at least one uppercase letter",N=async e=>{e.preventDefault(),g(null),x(null);let t=v(c);if(t){g(t);return}if(c!==u){g("New password and confirmation do not match");return}if(!y&&!r){g("Current password is required");return}p(!0);try{let e=y?"/api/auth/force-change-password":"/api/auth/change-password",t=y?{new_password:c,confirm_password:u}:{current_password:r,new_password:c,confirm_password:u},a=await fetch("http://localhost:8008".concat(e),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(localStorage.getItem("access_token"))},body:JSON.stringify(t)}),n=await a.json();a.ok?(x("Password changed successfully!"),setTimeout(()=>{y?window.location.href="/":(l(""),d(""),f(""))},2e3)):g(n.detail||"Failed to change password")}catch(e){g("Network error. Please try again.")}finally{p(!1)}};return e?(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen p-4",children:(0,a.jsxs)(i.Zb,{className:"p-8 w-full max-w-md space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-2xl font-semibold mb-2",children:y?"Change Your Password":"Change Password"}),y?(0,a.jsx)("p",{className:"text-sm text-muted-foreground mb-4",children:"You must change your password before continuing. Please choose a strong password."}):(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Update your account password"})]}),m&&(0,a.jsx)("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded",children:m}),w&&(0,a.jsx)("div",{className:"bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded",children:w}),(0,a.jsxs)("form",{onSubmit:N,className:"space-y-4",children:[!y&&(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm font-medium",htmlFor:"current-password",children:"Current Password"}),(0,a.jsx)("input",{id:"current-password",type:"password",value:r,onChange:e=>l(e.target.value),className:"w-full border rounded px-3 py-2 text-sm bg-background",placeholder:"Enter current password",required:!y})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm font-medium",htmlFor:"new-password",children:"New Password"}),(0,a.jsx)("input",{id:"new-password",type:"password",value:c,onChange:e=>d(e.target.value),className:"w-full border rounded px-3 py-2 text-sm bg-background",placeholder:"Enter new password",required:!0}),(0,a.jsx)("div",{className:"text-xs text-muted-foreground",children:"Password must contain at least 8 characters, including uppercase, lowercase, digit, and special character"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm font-medium",htmlFor:"confirm-password",children:"Confirm New Password"}),(0,a.jsx)("input",{id:"confirm-password",type:"password",value:u,onChange:e=>f(e.target.value),className:"w-full border rounded px-3 py-2 text-sm bg-background",placeholder:"Confirm new password",required:!0})]}),(0,a.jsxs)("div",{className:"flex gap-3 pt-4",children:[(0,a.jsx)(o.z,{type:"submit",disabled:h,className:"flex-1",children:h?"Changing...":"Change Password"}),!y&&(0,a.jsx)(o.z,{type:"button",variant:"outline",onClick:()=>{window.history.back()},disabled:h,children:"Cancel"})]})]}),y&&(0,a.jsx)("div",{className:"pt-4 border-t",children:(0,a.jsx)(o.z,{variant:"outline",onClick:()=>{t(),window.location.href="/login"},className:"w-full",children:"Logout Instead"})})]})}):(window.location.href="/login",null)}},2869:function(e,t,r){"use strict";r.d(t,{z:function(){return c}});var a=r(7437),n=r(2265),s=r(7495),o=r(535),i=r(4508);let l=(0,o.j)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground shadow hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",outline:"border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2",sm:"h-8 rounded-md px-3 text-xs",lg:"h-10 rounded-md px-8",icon:"h-9 w-9"}},defaultVariants:{variant:"default",size:"default"}}),c=n.forwardRef((e,t)=>{let{className:r,variant:n,size:o,asChild:c=!1,...d}=e,u=c?s.g7:"button";return(0,a.jsx)(u,{className:(0,i.cn)(l({variant:n,size:o,className:r})),ref:t,...d})});c.displayName="Button"},6070:function(e,t,r){"use strict";r.d(t,{Ol:function(){return i},SZ:function(){return c},Zb:function(){return o},aY:function(){return d},ll:function(){return l}});var a=r(7437),n=r(2265),s=r(4508);let o=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,s.cn)("rounded-xl border bg-card text-card-foreground shadow",r),...n})});o.displayName="Card";let i=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,s.cn)("flex flex-col space-y-1.5 p-6",r),...n})});i.displayName="CardHeader";let l=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,s.cn)("font-semibold leading-none tracking-tight",r),...n})});l.displayName="CardTitle";let c=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,s.cn)("text-sm text-muted-foreground",r),...n})});c.displayName="CardDescription";let d=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,s.cn)("p-6 pt-0",r),...n})});d.displayName="CardContent",n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,a.jsx)("div",{ref:t,className:(0,s.cn)("flex items-center p-6 pt-0",r),...n})}).displayName="CardFooter"},4508:function(e,t,r){"use strict";r.d(t,{cn:function(){return s}});var a=r(1994),n=r(3335);function s(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,n.m6)((0,a.W)(t))}},1245:function(e,t,r){"use strict";r.d(t,{AuthProvider:function(){return l},a:function(){return c}});var a=r(7437),n=r(2265);let s=(0,n.createContext)(void 0),o="tsa_auth_v1";function i(e){try{localStorage.setItem(o,JSON.stringify(e))}catch(e){}}let l=e=>{let{children:t}=e,[r,l]=(0,n.useState)({user:null,accessToken:null,refreshToken:null,expiresAt:null,loading:!0,error:null}),c=e=>l(t=>({...t,...e})),d=e=>e;(0,n.useEffect)(()=>{let e=!1;return(async()=>{let t=function(){try{let e=localStorage.getItem(o);if(!e)return null;return JSON.parse(e)}catch(e){return null}}();if(!(null==t?void 0:t.accessToken)){e||c({loading:!1});return}c({...t,loading:!0});try{let t=await fetch(d("/api/auth/health")).catch(()=>null);if(!t||!t.ok&&404!==t.status){e||c({loading:!1,error:"Auth service unavailable"});return}}catch(t){e||c({loading:!1,error:"Auth service unavailable"});return}try{let r=await fetch(d("/api/auth/me"),{headers:{Authorization:"Bearer ".concat(t.accessToken)}});if(r.ok){let t=await r.json();e||c({user:t,loading:!1})}else e||(c({loading:!1,accessToken:null,refreshToken:null,user:null}),i({}))}catch(t){e||c({loading:!1})}})(),()=>{e=!0}},[]);let u=(0,n.useCallback)(async(e,t)=>{c({loading:!0,error:null});try{let r=await fetch(d("/api/auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})});if(!r.ok){let e="Login failed";try{let t=await r.json();t&&"string"==typeof t.detail&&(e=t.detail)}catch(e){}return c({loading:!1,error:e}),!1}let a=null;try{a=await r.json()}catch(e){return c({loading:!1,error:"Malformed server response"}),!1}if(!a||"object"!=typeof a||!a.access_token||!a.refresh_token||"number"!=typeof a.expires_in||!a.user)return c({loading:!1,error:"Unexpected auth response"}),!1;let n=Number.isFinite(a.expires_in)?a.expires_in:0,s=Date.now()+Math.max(0,1e3*n-5e3),o={accessToken:a.access_token,refreshToken:a.refresh_token,expiresAt:s,user:a.user};return c({...o,loading:!1}),i(o),!0}catch(e){return c({loading:!1,error:"Network error"}),!1}},[]),f=(0,n.useCallback)(async e=>{c({loading:!0,error:null});try{let t=await fetch(d("/api/auth/register"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...e,role_id:e.role_id||2})});if(!t.ok){let e=(await t.json().catch(()=>({}))).detail||"Registration failed";return c({loading:!1,error:e}),!1}return c({loading:!1}),!0}catch(e){return c({loading:!1,error:"Network error"}),!1}},[]),h=(0,n.useCallback)(()=>{c({user:null,accessToken:null,refreshToken:null,expiresAt:null}),i({})},[]);(0,n.useEffect)(()=>{if(globalThis._tsaFetchWrapped)return;let e=fetch;globalThis._tsaFetchWrapped=!0,globalThis.fetch=async function(){for(var t=arguments.length,r=Array(t),a=0;a<t;a++)r[a]=arguments[a];let n=await e(...r);if(401===n.status){let e="string"==typeof r[0]?r[0]:r[0].url;if(!e.includes("/api/auth/login")&&!e.includes("/api/auth/register")&&(h(),!window.location.pathname.startsWith("/login")))try{window.location.pathname="/login"}catch(e){}}return n}},[h]);let p=(0,n.useCallback)(async()=>{if(r.refreshToken&&!p._inFlight){p._inFlight=!0;try{let e=await fetch(d("/api/auth/refresh"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:r.refreshToken})});if(!e.ok)return h();let t=await e.json(),a=1e3*t.expires_in,n=Date.now()+a-Math.min(5e3,Math.max(1e3,.08*a)),s={accessToken:t.access_token,expiresAt:n,user:t.user};c(s),i({...s,refreshToken:r.refreshToken})}catch(e){h()}finally{p._inFlight=!1}}},[r.refreshToken,h]);(0,n.useEffect)(()=>{if(!r.expiresAt)return;let e=r.expiresAt-Date.now();if(e<=0){p();return}let t=e-.12*e;t<1500&&(t=Math.min(Math.max(e-500,0),1500));let a=setTimeout(()=>p(),t);return()=>clearTimeout(a)},[r.expiresAt,p]);let m={...r,login:u,register:f,logout:h,refresh:p};return(0,a.jsx)(s.Provider,{value:m,children:t})};function c(){let e=(0,n.useContext)(s);if(!e)throw Error("useAuth must be used within AuthProvider");return e}}},function(e){e.O(0,[569,971,117,744],function(){return e(e.s=6456)}),_N_E=e.O()}]);