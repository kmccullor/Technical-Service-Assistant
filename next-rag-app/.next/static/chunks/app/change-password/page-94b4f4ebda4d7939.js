(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[973],{6456:function(e,r,t){Promise.resolve().then(t.bind(t,3334))},3334:function(e,r,t){"use strict";t.r(r),t.d(r,{default:function(){return u}});var n=t(7437),s=t(2265),o=t(9376),a=t(1245),l=t(2869),i=t(6070);function u(){let{user:e,logout:r,refresh:t,accessToken:u}=(0,a.a)(),c=(0,o.useRouter)(),[d,f]=(0,s.useState)(""),[h,g]=(0,s.useState)(""),[p,m]=(0,s.useState)(""),[w,y]=(0,s.useState)(!1),[v,x]=(0,s.useState)(null),[b,N]=(0,s.useState)(null),[_,k]=(0,s.useState)(!1),[j,C]=(0,s.useState)(!1);(0,s.useEffect)(()=>{console.log("[CHANGE_PWD] Password change page loaded for user:",{email:null==e?void 0:e.email,password_change_required:null==e?void 0:e.password_change_required}),(null==e?void 0:e.password_change_required)&&(console.log("[CHANGE_PWD] Setting forced password change mode"),k(!0))},[e]),(0,s.useEffect)(()=>{e||j||(console.log("[CHANGE_PWD] No user found, redirecting to login"),c.replace("/login"),C(!0))},[e,c,j]);let T=e=>e.length<8?"Password must be at least 8 characters long":/[A-Z]/.test(e)?/[a-z]/.test(e)?/\d/.test(e)?/[!@#$%^&*(),.?":{}|<>]/.test(e)?null:"Password must contain at least one special character":"Password must contain at least one digit":"Password must contain at least one lowercase letter":"Password must contain at least one uppercase letter",A=async e=>{e.preventDefault(),console.log("[CHANGE_PWD] Form submitted, isForced:",_),x(null),N(null);let n=T(h);if(n){x(n);return}if(h!==p){x("New password and confirmation do not match");return}if(!_&&!d){x("Current password is required");return}y(!0);try{let e=_?"/api/auth/force-change-password":"/api/auth/change-password",n=_?{new_password:h,confirm_password:p}:{current_password:d,new_password:h,confirm_password:p};console.log("[CHANGE_PWD] Sending password change request to:",e),console.log("[CHANGE_PWD] Payload type:",_?"force-change":"normal-change");let s=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",...u&&{Authorization:"Bearer ".concat(u)}},body:JSON.stringify(n)});console.log("[CHANGE_PWD] Password change response status:",s.status);let o=await s.json();if(s.ok){console.log("[CHANGE_PWD] Password change successful"),N("Password changed successfully. Redirecting to login...");try{console.log("[CHANGE_PWD] Refreshing user profile before logout"),await t()}catch(e){console.warn("[CHANGE_PWD] Failed to refresh profile after password change",e)}console.log("[CHANGE_PWD] Logging user out after password change"),C(!0),r(),c.replace("/login")}else x(o.detail||"Failed to change password")}catch(e){x("Network error. Please try again.")}finally{y(!1)}};return!e&&j?null:(0,n.jsx)("div",{className:"flex items-center justify-center min-h-screen p-4",children:(0,n.jsxs)(i.Zb,{className:"p-8 w-full max-w-md space-y-6",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h1",{className:"text-2xl font-semibold mb-2",children:_?"Change Your Password":"Change Password"}),_?(0,n.jsx)("p",{className:"text-sm text-muted-foreground mb-4",children:"You must change your password before continuing. Please choose a strong password."}):(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"Update your account password"})]}),v&&(0,n.jsx)("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded",children:v}),b&&(0,n.jsx)("div",{className:"bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded",children:b}),(0,n.jsxs)("form",{onSubmit:A,className:"space-y-4",children:[!_&&(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("label",{className:"text-sm font-medium",htmlFor:"current-password",children:"Current Password"}),(0,n.jsx)("input",{id:"current-password",type:"password",value:d,onChange:e=>f(e.target.value),className:"w-full border rounded px-3 py-2 text-sm bg-background",placeholder:"Enter current password",required:!_})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("label",{className:"text-sm font-medium",htmlFor:"new-password",children:"New Password"}),(0,n.jsx)("input",{id:"new-password",type:"password",value:h,onChange:e=>g(e.target.value),className:"w-full border rounded px-3 py-2 text-sm bg-background",placeholder:"Enter new password",required:!0}),(0,n.jsx)("div",{className:"text-xs text-muted-foreground",children:"Password must contain at least 8 characters, including uppercase, lowercase, digit, and special character"})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("label",{className:"text-sm font-medium",htmlFor:"confirm-password",children:"Confirm New Password"}),(0,n.jsx)("input",{id:"confirm-password",type:"password",value:p,onChange:e=>m(e.target.value),className:"w-full border rounded px-3 py-2 text-sm bg-background",placeholder:"Confirm new password",required:!0})]}),(0,n.jsxs)("div",{className:"flex gap-3 pt-4",children:[(0,n.jsx)(l.z,{type:"submit",disabled:w,className:"flex-1",children:w?"Changing...":"Change Password"}),!_&&(0,n.jsx)(l.z,{type:"button",variant:"outline",onClick:()=>c.back(),disabled:w,children:"Cancel"})]})]}),_&&(0,n.jsx)("div",{className:"pt-4 border-t",children:(0,n.jsx)(l.z,{variant:"outline",onClick:()=>{r(),c.push("/login")},className:"w-full",children:"Logout Instead"})})]})})}},2869:function(e,r,t){"use strict";t.d(r,{z:function(){return u}});var n=t(7437),s=t(2265),o=t(7495),a=t(535),l=t(4508);let i=(0,a.j)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground shadow hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",outline:"border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2",sm:"h-8 rounded-md px-3 text-xs",lg:"h-10 rounded-md px-8",icon:"h-9 w-9"}},defaultVariants:{variant:"default",size:"default"}}),u=s.forwardRef((e,r)=>{let{className:t,variant:s,size:a,asChild:u=!1,...c}=e,d=u?o.g7:"button";return(0,n.jsx)(d,{className:(0,l.cn)(i({variant:s,size:a,className:t})),ref:r,...c})});u.displayName="Button"},6070:function(e,r,t){"use strict";t.d(r,{Ol:function(){return l},SZ:function(){return u},Zb:function(){return a},aY:function(){return c},ll:function(){return i}});var n=t(7437),s=t(2265),o=t(4508);let a=s.forwardRef((e,r)=>{let{className:t,...s}=e;return(0,n.jsx)("div",{ref:r,className:(0,o.cn)("rounded-xl border bg-card text-card-foreground shadow",t),...s})});a.displayName="Card";let l=s.forwardRef((e,r)=>{let{className:t,...s}=e;return(0,n.jsx)("div",{ref:r,className:(0,o.cn)("flex flex-col space-y-1.5 p-6",t),...s})});l.displayName="CardHeader";let i=s.forwardRef((e,r)=>{let{className:t,...s}=e;return(0,n.jsx)("div",{ref:r,className:(0,o.cn)("font-semibold leading-none tracking-tight",t),...s})});i.displayName="CardTitle";let u=s.forwardRef((e,r)=>{let{className:t,...s}=e;return(0,n.jsx)("div",{ref:r,className:(0,o.cn)("text-sm text-muted-foreground",t),...s})});u.displayName="CardDescription";let c=s.forwardRef((e,r)=>{let{className:t,...s}=e;return(0,n.jsx)("div",{ref:r,className:(0,o.cn)("p-6 pt-0",t),...s})});c.displayName="CardContent",s.forwardRef((e,r)=>{let{className:t,...s}=e;return(0,n.jsx)("div",{ref:r,className:(0,o.cn)("flex items-center p-6 pt-0",t),...s})}).displayName="CardFooter"},4508:function(e,r,t){"use strict";t.d(r,{G:function(){return a},cn:function(){return o}});var n=t(1994),s=t(3335);function o(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return(0,s.m6)((0,n.W)(r))}function a(e){return e}},9376:function(e,r,t){"use strict";var n=t(5475);t.o(n,"useRouter")&&t.d(r,{useRouter:function(){return n.useRouter}}),t.o(n,"useSearchParams")&&t.d(r,{useSearchParams:function(){return n.useSearchParams}})},1245:function(e,r,t){"use strict";t.d(r,{AuthProvider:function(){return i},a:function(){return u}});var n=t(7437),s=t(2265);let o=(0,s.createContext)(void 0),a="tsa_auth_v1";function l(e){try{localStorage.setItem(a,JSON.stringify(e))}catch(e){}}let i=e=>{let{children:r}=e,[t,i]=(0,s.useState)({user:null,accessToken:null,refreshToken:null,expiresAt:null,loading:!0,error:null}),u=e=>i(r=>({...r,...e})),c=e=>e;(0,s.useEffect)(()=>{let e=!1;return(async()=>{console.log("[AUTH] Initializing auth context");let r=function(){try{let e=localStorage.getItem(a);if(!e)return null;return JSON.parse(e)}catch(e){return null}}();if(console.log("[AUTH] Persisted state:",r?"Found tokens":"No tokens"),!(null==r?void 0:r.accessToken)){console.log("[AUTH] No access token found, setting loading false"),e||u({loading:!1});return}console.log("[AUTH] Found access token, loading user profile"),u({...r,loading:!0});try{let r=await fetch(c("/api/auth/health")).catch(()=>null);if(!r||!r.ok&&404!==r.status){e||u({loading:!1,error:"Auth service unavailable"});return}}catch(r){e||u({loading:!1,error:"Auth service unavailable"});return}try{console.log("[AUTH] Fetching user profile from /api/auth/me");let t=await fetch(c("/api/auth/me"),{headers:{Authorization:"Bearer ".concat(r.accessToken)}});if(console.log("[AUTH] Profile fetch response status:",t.status),t.ok){let r=await t.json();console.log("[AUTH] Profile loaded:",{id:r.id,email:r.email,password_change_required:r.password_change_required}),e||u({user:r,loading:!1})}else e||(u({loading:!1,accessToken:null,refreshToken:null,user:null}),l({}))}catch(r){e||u({loading:!1})}})(),()=>{e=!0}},[]);let d=(0,s.useCallback)(async(e,r)=>{console.log("[AUTH] Login attempt for:",e),u({loading:!0,error:null});try{var t;console.log("[AUTH] Sending login request to:",c("/api/auth/login"));let n=await fetch(c("/api/auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:r})});if(console.log("[AUTH] Login response status:",n.status),!n.ok){let e="Login failed";try{let r=await n.json();r&&"string"==typeof r.detail&&(e=r.detail)}catch(e){}return u({loading:!1,error:e}),!1}let s=null;try{s=await n.json()}catch(e){return u({loading:!1,error:"Malformed server response"}),!1}if(console.log("[AUTH] Login response data:",{hasAccessToken:!!s.access_token,hasRefreshToken:!!s.refresh_token,hasUser:!!s.user,userPasswordChangeRequired:null===(t=s.user)||void 0===t?void 0:t.password_change_required}),!s||"object"!=typeof s||!s.access_token||!s.refresh_token||"number"!=typeof s.expires_in||!s.user)return console.log("[AUTH] Invalid login response data"),u({loading:!1,error:"Unexpected auth response"}),!1;let o=Number.isFinite(s.expires_in)?s.expires_in:0,a=Date.now()+Math.max(0,1e3*o-5e3),i={accessToken:s.access_token,refreshToken:s.refresh_token,expiresAt:a,user:s.user};return console.log("[AUTH] Login successful, setting user state:",{email:s.user.email,password_change_required:s.user.password_change_required}),u({...i,loading:!1}),l(i),!0}catch(e){return u({loading:!1,error:"Network error"}),!1}},[]),f=(0,s.useCallback)(async e=>{u({loading:!0,error:null});try{let r=await fetch(c("/api/auth/register"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...e,role_id:e.role_id||2})});if(!r.ok){let e=(await r.json().catch(()=>({}))).detail||"Registration failed";return u({loading:!1,error:e}),!1}return u({loading:!1}),!0}catch(e){return u({loading:!1,error:"Network error"}),!1}},[]),h=(0,s.useCallback)(()=>{if(u({user:null,accessToken:null,refreshToken:null,expiresAt:null}),l({}),!window.location.pathname.startsWith("/login"))try{window.location.href="/login"}catch(e){}},[]);(0,s.useEffect)(()=>{if(globalThis._tsaFetchWrapped)return;let e=fetch;globalThis._tsaFetchWrapped=!0,globalThis.fetch=async function(){for(var r=arguments.length,t=Array(r),n=0;n<r;n++)t[n]=arguments[n];let s=await e(...t);if(401===s.status){let e="string"==typeof t[0]?t[0]:t[0].url;if(!e.includes("/api/auth/login")&&!e.includes("/api/auth/register")&&(h(),!window.location.pathname.startsWith("/login")))try{window.location.pathname="/login"}catch(e){}}return s}},[h]);let g=(0,s.useCallback)(async()=>{if(console.log("[AUTH] Refresh called"),!t.refreshToken){console.log("[AUTH] No refresh token available");return}if(g._inFlight){console.log("[AUTH] Refresh already in flight");return}console.log("[AUTH] Starting token refresh"),g._inFlight=!0;try{var e,r;let n=await fetch(c("/api/auth/refresh"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:t.refreshToken})});if(console.log("[AUTH] Refresh response status:",n.status),!n.ok)return console.log("[AUTH] Refresh failed, logging out"),h();let s=await n.json();console.log("[AUTH] Refresh successful, updated user:",{email:null===(e=s.user)||void 0===e?void 0:e.email,password_change_required:null===(r=s.user)||void 0===r?void 0:r.password_change_required});let o=1e3*s.expires_in,a=Date.now()+o-Math.min(5e3,Math.max(1e3,.08*o)),i={accessToken:s.access_token,expiresAt:a,user:s.user};u(i),l({...i,refreshToken:t.refreshToken})}catch(e){h()}finally{g._inFlight=!1}},[t.refreshToken,h]);(0,s.useEffect)(()=>{if(!t.expiresAt)return;let e=t.expiresAt-Date.now();if(e<=0){g();return}let r=e-.12*e;r<1500&&(r=Math.min(Math.max(e-500,0),1500));let n=setTimeout(()=>g(),r);return()=>clearTimeout(n)},[t.expiresAt,g]);let p={...t,login:d,register:f,logout:h,refresh:g};return(0,n.jsx)(o.Provider,{value:p,children:r})};function u(){let e=(0,s.useContext)(o);if(!e)throw Error("useAuth must be used within AuthProvider");return e}},8575:function(e,r,t){"use strict";t.d(r,{F:function(){return o},e:function(){return a}});var n=t(2265);function s(e,r){if("function"==typeof e)return e(r);null!=e&&(e.current=r)}function o(...e){return r=>{let t=!1,n=e.map(e=>{let n=s(e,r);return t||"function"!=typeof n||(t=!0),n});if(t)return()=>{for(let r=0;r<n.length;r++){let t=n[r];"function"==typeof t?t():s(e[r],null)}}}}function a(...e){return n.useCallback(o(...e),e)}},7495:function(e,r,t){"use strict";t.d(r,{Z8:function(){return a},g7:function(){return l}});var n=t(2265),s=t(8575),o=t(7437);function a(e){let r=function(e){let r=n.forwardRef((e,r)=>{let{children:t,...o}=e;if(n.isValidElement(t)){let e,a;let l=(e=Object.getOwnPropertyDescriptor(t.props,"ref")?.get)&&"isReactWarning"in e&&e.isReactWarning?t.ref:(e=Object.getOwnPropertyDescriptor(t,"ref")?.get)&&"isReactWarning"in e&&e.isReactWarning?t.props.ref:t.props.ref||t.ref,i=function(e,r){let t={...r};for(let n in r){let s=e[n],o=r[n];/^on[A-Z]/.test(n)?s&&o?t[n]=(...e)=>{let r=o(...e);return s(...e),r}:s&&(t[n]=s):"style"===n?t[n]={...s,...o}:"className"===n&&(t[n]=[s,o].filter(Boolean).join(" "))}return{...e,...t}}(o,t.props);return t.type!==n.Fragment&&(i.ref=r?(0,s.F)(r,l):l),n.cloneElement(t,i)}return n.Children.count(t)>1?n.Children.only(null):null});return r.displayName=`${e}.SlotClone`,r}(e),t=n.forwardRef((e,t)=>{let{children:s,...a}=e,l=n.Children.toArray(s),i=l.find(u);if(i){let e=i.props.children,s=l.map(r=>r!==i?r:n.Children.count(e)>1?n.Children.only(null):n.isValidElement(e)?e.props.children:null);return(0,o.jsx)(r,{...a,ref:t,children:n.isValidElement(e)?n.cloneElement(e,void 0,s):null})}return(0,o.jsx)(r,{...a,ref:t,children:s})});return t.displayName=`${e}.Slot`,t}var l=a("Slot"),i=Symbol("radix.slottable");function u(e){return n.isValidElement(e)&&"function"==typeof e.type&&"__radixId"in e.type&&e.type.__radixId===i}},535:function(e,r,t){"use strict";t.d(r,{j:function(){return a}});var n=t(1994);let s=e=>"boolean"==typeof e?`${e}`:0===e?"0":e,o=n.W,a=(e,r)=>t=>{var n;if((null==r?void 0:r.variants)==null)return o(e,null==t?void 0:t.class,null==t?void 0:t.className);let{variants:a,defaultVariants:l}=r,i=Object.keys(a).map(e=>{let r=null==t?void 0:t[e],n=null==l?void 0:l[e];if(null===r)return null;let o=s(r)||s(n);return a[e][o]}),u=t&&Object.entries(t).reduce((e,r)=>{let[t,n]=r;return void 0===n||(e[t]=n),e},{});return o(e,i,null==r?void 0:null===(n=r.compoundVariants)||void 0===n?void 0:n.reduce((e,r)=>{let{class:t,className:n,...s}=r;return Object.entries(s).every(e=>{let[r,t]=e;return Array.isArray(t)?t.includes({...l,...u}[r]):({...l,...u})[r]===t})?[...e,t,n]:e},[]),null==t?void 0:t.class,null==t?void 0:t.className)}}},function(e){e.O(0,[137,971,117,744],function(){return e(e.s=6456)}),_N_E=e.O()}]);