(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3],{5007:function(e,t,a){Promise.resolve().then(a.bind(a,5300))},5300:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return f}});var s=a(7437),r=a(2265),n=a(1245);async function l(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=await fetch(e,{...a,headers:{"Content-Type":"application/json",...a.headers||{},...t?{Authorization:"Bearer ".concat(t)}:{}}});if(!s.ok)throw Error((await s.json().catch(()=>({}))).detail||"Request failed: ".concat(s.status));return s.json()}async function i(e){let t=new URLSearchParams;return e.search&&t.set("search",e.search),e.page&&t.set("page",String(e.page)),e.page_size&&t.set("page_size",String(e.page_size)),l("/api/admin/users?".concat(t.toString()),e.accessToken)}async function d(e,t,a){return l("/api/admin/users/".concat(t),e,{method:"PATCH",body:JSON.stringify(a)})}async function c(e){return l("/api/admin/roles",e)}async function o(e,t,a){return l("/api/admin/roles/".concat(t),e,{method:"PATCH",body:JSON.stringify(a)})}async function u(e,t){return l("/api/admin/users",e,{method:"POST",body:JSON.stringify(t)})}async function m(e,t){let a=await fetch("/api/admin/users/".concat(t),{method:"DELETE",headers:{...e?{Authorization:"Bearer ".concat(e)}:{}}});if(!a.ok&&204!==a.status)throw Error((await a.json().catch(()=>({}))).detail||"Delete failed: ".concat(a.status))}var h=a(7648),x=a(8906);let p=(0,a(9205).Z)("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);function f(){let{user:e,accessToken:t,loading:a}=(0,n.a)(),[l,f]=(0,r.useState)([]),[g,j]=(0,r.useState)([]),[N,y]=(0,r.useState)(!0),[b,v]=(0,r.useState)(null),[w,k]=(0,r.useState)(""),[_,C]=(0,r.useState)(null),[S,T]=(0,r.useState)(null),[A,D]=(0,r.useState)(!1),[E,O]=(0,r.useState)({email:"",password:"",first_name:"",last_name:"",role_id:2}),[P,L]=(0,r.useState)(!1),[R,M]=(0,r.useState)(null);(0,r.useEffect)(()=>{t&&e&&"admin"===e.role_name&&F()},[t,null==e?void 0:e.role_name]);let F=async()=>{try{y(!0);let[e,a]=await Promise.all([i({accessToken:t,search:w}),c(t)]);f(e.users),j(a),v(null)}catch(e){v(e.message||"Failed to load admin data")}finally{y(!1)}},z=async(e,a)=>{try{C(e);let s=await d(t,e,{role_id:a});f(t=>t.map(t=>t.id===e?s:t))}catch(e){alert(e.message)}finally{C(null)}},J=async(e,a)=>{try{C(e);let s=await d(t,e,{status:a});f(t=>t.map(t=>t.id===e?s:t))}catch(e){alert(e.message)}finally{C(null)}},U=async(e,a)=>{try{T(e);let s=await o(t,e,{description:a});j(t=>t.map(t=>t.id===e?s:t))}catch(e){alert(e.message)}finally{T(null)}},q=async e=>{let a=l.find(t=>t.id===e);if(a&&confirm("Delete user ".concat(a.email,"? This action cannot be undone.")))try{M(e),await m(t,e),f(t=>t.filter(t=>t.id!==e))}catch(e){alert(e.message||"Failed to delete user")}finally{M(null)}},B=async e=>{if(e.preventDefault(),!E.email||!E.password){alert("Email and password are required");return}try{L(!0);let e=await u(t,E);f(t=>[e,...t]),O({email:"",password:"",first_name:"",last_name:"",role_id:2}),D(!1),alert("User created successfully!")}catch(e){alert(e.message||"Failed to create user")}finally{L(!1)}};return a||N?(0,s.jsx)("div",{className:"flex items-center justify-center h-screen text-muted-foreground",children:"Loading..."}):e?"admin"!==e.role_name?(0,s.jsxs)("div",{className:"p-8 text-center space-y-4",children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold",children:"Access Denied"}),(0,s.jsx)("p",{className:"text-muted-foreground",children:"You do not have permission to view administrative controls."}),(0,s.jsx)(h.default,{href:"/",className:"underline",children:"Return Home"})]}):(0,s.jsxs)("div",{className:"flex flex-col h-screen",children:[(0,s.jsxs)("div",{className:"border-b p-4 flex items-center justify-between bg-muted/30",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(h.default,{href:"/",className:"text-muted-foreground hover:text-foreground mr-2",children:"← Back"}),(0,s.jsx)(x.Z,{className:"h-5 w-5"}),(0,s.jsx)("h1",{className:"text-xl font-semibold",children:"Admin Dashboard"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("input",{className:"border rounded px-2 py-1 text-sm",placeholder:"Search users",value:w,onChange:e=>k(e.target.value)}),(0,s.jsxs)("button",{onClick:F,className:"inline-flex items-center gap-1 border rounded px-3 py-1 text-sm hover:bg-muted",children:[(0,s.jsx)(p,{className:"h-4 w-4"})," Refresh"]})]})]}),b&&(0,s.jsx)("div",{className:"p-4 text-sm text-red-600",children:b}),N?(0,s.jsx)("div",{className:"flex-1 flex items-center justify-center text-muted-foreground",children:"Loading..."}):(0,s.jsxs)("div",{className:"flex-1 overflow-auto p-6 space-y-10",children:[(0,s.jsxs)("section",{children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-3",children:[(0,s.jsx)("h2",{className:"text-lg font-medium",children:"Users"}),(0,s.jsx)("button",{onClick:()=>D(!A),className:"px-3 py-1 bg-primary text-primary-foreground rounded text-sm hover:bg-primary/90",children:A?"Cancel":"Add User"})]}),A&&(0,s.jsxs)("div",{className:"mb-4 p-4 border rounded bg-muted/20",children:[(0,s.jsx)("h3",{className:"text-md font-medium mb-3",children:"Create New User"}),(0,s.jsxs)("form",{onSubmit:B,className:"grid grid-cols-2 gap-3",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Email *"}),(0,s.jsx)("input",{type:"email",required:!0,value:E.email,onChange:e=>O(t=>({...t,email:e.target.value})),className:"w-full border rounded px-2 py-1 text-sm"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Password *"}),(0,s.jsx)("input",{type:"password",required:!0,value:E.password,onChange:e=>O(t=>({...t,password:e.target.value})),className:"w-full border rounded px-2 py-1 text-sm"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium mb-1",children:"First Name"}),(0,s.jsx)("input",{type:"text",value:E.first_name,onChange:e=>O(t=>({...t,first_name:e.target.value})),className:"w-full border rounded px-2 py-1 text-sm"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Last Name"}),(0,s.jsx)("input",{type:"text",value:E.last_name,onChange:e=>O(t=>({...t,last_name:e.target.value})),className:"w-full border rounded px-2 py-1 text-sm"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Role"}),(0,s.jsx)("select",{value:E.role_id,onChange:e=>O(t=>({...t,role_id:Number(e.target.value)})),className:"w-full border rounded px-2 py-1 text-sm",children:g.map(e=>(0,s.jsx)("option",{value:e.id,children:e.name},e.id))})]}),(0,s.jsx)("div",{className:"flex items-end",children:(0,s.jsx)("button",{type:"submit",disabled:P,className:"px-4 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 disabled:opacity-50",children:P?"Creating...":"Create User"})})]})]}),(0,s.jsx)("div",{className:"overflow-x-auto border rounded",children:(0,s.jsxs)("table",{className:"min-w-full text-sm",children:[(0,s.jsx)("thead",{className:"bg-muted/50",children:(0,s.jsxs)("tr",{className:"text-left",children:[(0,s.jsx)("th",{className:"p-2",children:"ID"}),(0,s.jsx)("th",{className:"p-2",children:"Email"}),(0,s.jsx)("th",{className:"p-2",children:"Name"}),(0,s.jsx)("th",{className:"p-2",children:"Role"}),(0,s.jsx)("th",{className:"p-2",children:"Status"}),(0,s.jsx)("th",{className:"p-2",children:"Verified"}),(0,s.jsx)("th",{className:"p-2",children:"Updated"}),(0,s.jsx)("th",{className:"p-2",children:"Actions"})]})}),(0,s.jsxs)("tbody",{children:[l.map(t=>{var a;return(0,s.jsxs)("tr",{className:"border-t",children:[(0,s.jsx)("td",{className:"p-2 font-mono text-xs",children:t.id}),(0,s.jsx)("td",{className:"p-2",children:t.email}),(0,s.jsx)("td",{className:"p-2",children:t.full_name}),(0,s.jsx)("td",{className:"p-2",children:(0,s.jsx)("select",{className:"border rounded px-1 py-0.5 text-xs",value:t.role_id,disabled:_===t.id,onChange:e=>z(t.id,Number(e.target.value)),children:g.map(e=>(0,s.jsx)("option",{value:e.id,children:e.name},e.id))})}),(0,s.jsx)("td",{className:"p-2",children:(0,s.jsxs)("select",{className:"border rounded px-1 py-0.5 text-xs",value:t.status,disabled:_===t.id,onChange:e=>J(t.id,e.target.value),children:[(0,s.jsx)("option",{value:"active",children:"active"}),(0,s.jsx)("option",{value:"disabled",children:"disabled"}),(0,s.jsx)("option",{value:"pending",children:"pending"})]})}),(0,s.jsx)("td",{className:"p-2 text-center",children:t.verified?"✅":"❌"}),(0,s.jsx)("td",{className:"p-2 text-xs text-muted-foreground",children:null===(a=t.updated_at)||void 0===a?void 0:a.replace("T"," ").substring(0,16)}),(0,s.jsx)("td",{className:"p-2",children:(0,s.jsx)("button",{onClick:()=>q(t.id),disabled:R===t.id||t.id===e.id,className:"text-xs px-2 py-0.5 rounded border border-red-600 text-red-600 hover:bg-red-600 hover:text-white disabled:opacity-40",title:t.id===e.id?"Cannot delete current logged in user":"Delete user",children:R===t.id?"Deleting...":"Delete"})})]},t.id)}),0===l.length&&(0,s.jsx)("tr",{children:(0,s.jsx)("td",{colSpan:8,className:"p-4 text-center text-muted-foreground",children:"No users found."})})]})]})})]}),(0,s.jsxs)("section",{children:[(0,s.jsx)("h2",{className:"text-lg font-medium mb-3",children:"Roles"}),(0,s.jsx)("div",{className:"overflow-x-auto border rounded",children:(0,s.jsxs)("table",{className:"min-w-full text-sm",children:[(0,s.jsx)("thead",{className:"bg-muted/50",children:(0,s.jsxs)("tr",{className:"text-left",children:[(0,s.jsx)("th",{className:"p-2",children:"ID"}),(0,s.jsx)("th",{className:"p-2",children:"Name"}),(0,s.jsx)("th",{className:"p-2",children:"Description"}),(0,s.jsx)("th",{className:"p-2",children:"System"}),(0,s.jsx)("th",{className:"p-2",children:"Permissions"})]})}),(0,s.jsx)("tbody",{children:g.map(e=>(0,s.jsxs)("tr",{className:"border-t",children:[(0,s.jsx)("td",{className:"p-2 font-mono text-xs",children:e.id}),(0,s.jsx)("td",{className:"p-2 font-medium",children:e.name}),(0,s.jsx)("td",{className:"p-2",children:e.system?(0,s.jsx)("span",{className:"text-muted-foreground text-xs",children:e.description||"—"}):(0,s.jsx)("input",{className:"border rounded px-1 py-0.5 text-xs w-56",defaultValue:e.description||"",disabled:S===e.id,onBlur:t=>{t.target.value!==e.description&&U(e.id,t.target.value)}})}),(0,s.jsx)("td",{className:"p-2 text-center",children:e.system?"\uD83D\uDD12":""}),(0,s.jsx)("td",{className:"p-2 text-xs",children:(0,s.jsxs)("div",{className:"flex flex-wrap gap-1 max-w-xs",children:[(e.permissions||[]).map(e=>(0,s.jsx)("span",{className:"px-1.5 py-0.5 rounded bg-secondary text-[10px] tracking-wide uppercase",children:e},e)),(!e.permissions||0===e.permissions.length)&&(0,s.jsx)("span",{className:"text-muted-foreground",children:"—"})]})})]},e.id))})]})})]})]})]}):(0,s.jsxs)("div",{className:"p-8 text-center space-y-4",children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold",children:"Authentication Required"}),(0,s.jsx)("p",{className:"text-muted-foreground",children:"You must be logged in to view this page."}),(0,s.jsx)(h.default,{href:"/login",className:"underline",children:"Go to Login"})]})}},9205:function(e,t,a){"use strict";a.d(t,{Z:function(){return d}});var s=a(2265);let r=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),n=function(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return t.filter((e,t,a)=>!!e&&""!==e.trim()&&a.indexOf(e)===t).join(" ").trim()};var l={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let i=(0,s.forwardRef)((e,t)=>{let{color:a="currentColor",size:r=24,strokeWidth:i=2,absoluteStrokeWidth:d,className:c="",children:o,iconNode:u,...m}=e;return(0,s.createElement)("svg",{ref:t,...l,width:r,height:r,stroke:a,strokeWidth:d?24*Number(i)/Number(r):i,className:n("lucide",c),...m},[...u.map(e=>{let[t,a]=e;return(0,s.createElement)(t,a)}),...Array.isArray(o)?o:[o]])}),d=(e,t)=>{let a=(0,s.forwardRef)((a,l)=>{let{className:d,...c}=a;return(0,s.createElement)(i,{ref:l,iconNode:t,className:n("lucide-".concat(r(e)),d),...c})});return a.displayName="".concat(e),a}},8906:function(e,t,a){"use strict";a.d(t,{Z:function(){return s}});let s=(0,a(9205).Z)("Shield",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]])},1245:function(e,t,a){"use strict";a.d(t,{AuthProvider:function(){return d},a:function(){return c}});var s=a(7437),r=a(2265);let n=(0,r.createContext)(void 0),l="tsa_auth_v1";function i(e){try{localStorage.setItem(l,JSON.stringify(e))}catch(e){}}let d=e=>{let{children:t}=e,[a,d]=(0,r.useState)({user:null,accessToken:null,refreshToken:null,expiresAt:null,loading:!0,error:null}),c=e=>d(t=>({...t,...e})),o=e=>e;(0,r.useEffect)(()=>{let e=!1;return(async()=>{let t=function(){try{let e=localStorage.getItem(l);if(!e)return null;return JSON.parse(e)}catch(e){return null}}();if(!(null==t?void 0:t.accessToken)){e||c({loading:!1});return}c({...t,loading:!0});try{let t=await fetch(o("/api/auth/health")).catch(()=>null);if(!t||!t.ok&&404!==t.status){e||c({loading:!1,error:"Auth service unavailable"});return}}catch(t){e||c({loading:!1,error:"Auth service unavailable"});return}try{let a=await fetch(o("/api/auth/me"),{headers:{Authorization:"Bearer ".concat(t.accessToken)}});if(a.ok){let t=await a.json();e||c({user:t,loading:!1})}else e||(c({loading:!1,accessToken:null,refreshToken:null,user:null}),i({}))}catch(t){e||c({loading:!1})}})(),()=>{e=!0}},[]);let u=(0,r.useCallback)(async(e,t)=>{c({loading:!0,error:null});try{let a=await fetch(o("/api/auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})});if(!a.ok){let e="Login failed";try{let t=await a.json();t&&"string"==typeof t.detail&&(e=t.detail)}catch(e){}return c({loading:!1,error:e}),!1}let s=null;try{s=await a.json()}catch(e){return c({loading:!1,error:"Malformed server response"}),!1}if(!s||"object"!=typeof s||!s.access_token||!s.refresh_token||"number"!=typeof s.expires_in||!s.user)return c({loading:!1,error:"Unexpected auth response"}),!1;let r=Number.isFinite(s.expires_in)?s.expires_in:0,n=Date.now()+Math.max(0,1e3*r-5e3),l={accessToken:s.access_token,refreshToken:s.refresh_token,expiresAt:n,user:s.user};return c({...l,loading:!1}),i(l),!0}catch(e){return c({loading:!1,error:"Network error"}),!1}},[]),m=(0,r.useCallback)(async e=>{c({loading:!0,error:null});try{let t=await fetch(o("/api/auth/register"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...e,role_id:e.role_id||2})});if(!t.ok){let e=(await t.json().catch(()=>({}))).detail||"Registration failed";return c({loading:!1,error:e}),!1}return c({loading:!1}),!0}catch(e){return c({loading:!1,error:"Network error"}),!1}},[]),h=(0,r.useCallback)(()=>{c({user:null,accessToken:null,refreshToken:null,expiresAt:null}),i({})},[]);(0,r.useEffect)(()=>{if(globalThis._tsaFetchWrapped)return;let e=fetch;globalThis._tsaFetchWrapped=!0,globalThis.fetch=async function(){for(var t=arguments.length,a=Array(t),s=0;s<t;s++)a[s]=arguments[s];let r=await e(...a);if(401===r.status){let e="string"==typeof a[0]?a[0]:a[0].url;if(!e.includes("/api/auth/login")&&!e.includes("/api/auth/register")&&(h(),!window.location.pathname.startsWith("/login")))try{window.location.pathname="/login"}catch(e){}}return r}},[h]);let x=(0,r.useCallback)(async()=>{if(a.refreshToken&&!x._inFlight){x._inFlight=!0;try{let e=await fetch(o("/api/auth/refresh"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:a.refreshToken})});if(!e.ok)return h();let t=await e.json(),s=1e3*t.expires_in,r=Date.now()+s-Math.min(5e3,Math.max(1e3,.08*s)),n={accessToken:t.access_token,expiresAt:r,user:t.user};c(n),i({...n,refreshToken:a.refreshToken})}catch(e){h()}finally{x._inFlight=!1}}},[a.refreshToken,h]);(0,r.useEffect)(()=>{if(!a.expiresAt)return;let e=a.expiresAt-Date.now();if(e<=0){x();return}let t=e-.12*e;t<1500&&(t=Math.min(Math.max(e-500,0),1500));let s=setTimeout(()=>x(),t);return()=>clearTimeout(s)},[a.expiresAt,x]);let p={...a,login:u,register:m,logout:h,refresh:x};return(0,s.jsx)(n.Provider,{value:p,children:t})};function c(){let e=(0,r.useContext)(n);if(!e)throw Error("useAuth must be used within AuthProvider");return e}}},function(e){e.O(0,[648,971,117,744],function(){return e(e.s=5007)}),_N_E=e.O()}]);