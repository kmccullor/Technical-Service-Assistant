(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3],{5007:function(e,t,s){Promise.resolve().then(s.bind(s,5300))},5300:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return w}});var a=s(7437),r=s(2265),n=s(1245),l=s(4508);let i={active:"active",inactive:"disabled",suspended:"disabled",pending_verification:"pending"},o={active:"active",disabled:"inactive",pending:"pending_verification"};function d(e){if(!e)return null;let t=e.trim();return t.length?t:null}function c(e){var t,s,a,r,n,l,o;let c="first_name"in e?e.first_name:null,u="last_name"in e?e.last_name:null,m=null!==(s=null==c?void 0:c.trim())&&void 0!==s?s:"",h=null!==(a=null==u?void 0:u.trim())&&void 0!==a?a:"",f=("full_name"in e&&null!==(r=null===(t=e.full_name)||void 0===t?void 0:t.trim())&&void 0!==r?r:"")||"".concat(m," ").concat(h).trim()||e.email,p=null!==(n="string"==typeof e.status?e.status:void 0)&&void 0!==n?n:"active";return{id:e.id,email:e.email,first_name:d(c),last_name:d(u),role_id:function(e){if("number"==typeof e)return e;if("string"==typeof e){let t=Number.parseInt(e,10);if(Number.isFinite(t))return t}return 0}(e.role_id),role_name:null!==(l=e.role_name)&&void 0!==l?l:"",status:null!==(o=i[p])&&void 0!==o?o:"active",full_name:f,verified:!!(!("verified"in e)||e.verified),created_at:e.created_at,updated_at:e.updated_at}}function u(e){var t;return{id:e.id,name:e.name,description:null!==(t=e.description)&&void 0!==t?t:null,permissions:Array.isArray(e.permissions)?e.permissions:[],system:!!("boolean"==typeof e.is_system?e.is_system:"boolean"==typeof e.system?e.system:e.is_system_role),user_count:"number"==typeof e.user_count?e.user_count:0}}async function m(e){try{let t=await e.clone().json();if("string"==typeof(null==t?void 0:t.detail))return Error(t.detail);if("string"==typeof(null==t?void 0:t.message))return Error(t.message)}catch(e){}return Error(e.statusText||"Request failed")}async function h(e,t,s){let a=new Headers(null==s?void 0:s.headers);a.set("Authorization","Bearer ".concat(t)),(null==s?void 0:s.body)&&!a.has("Content-Type")&&a.set("Content-Type","application/json");let r=await fetch((0,l.G)(e),{...s,headers:a,cache:"no-store"});if(!r.ok)throw await m(r);if(204!==r.status)return await r.json()}async function f(e){let t=new URLSearchParams;e.limit&&t.set("limit",String(e.limit)),e.offset&&t.set("offset",String(e.offset)),e.search&&t.set("search",e.search.trim());let s=t.toString(),a=await h("/api/admin/users".concat(s?"?".concat(s):""),e.accessToken,{method:"GET"}),r=Array.isArray(null==a?void 0:a.items)?a.items:Array.isArray(null==a?void 0:a.users)?a.users:[],n="number"==typeof(null==a?void 0:a.limit)?a.limit:"number"==typeof(null==a?void 0:a.page_size)?a.page_size:r.length,l="number"==typeof(null==a?void 0:a.offset)?a.offset:"number"==typeof(null==a?void 0:a.page)&&n?Math.max(a.page-1,0)*n:0,i="number"==typeof(null==a?void 0:a.total)?a.total:"number"==typeof(null==a?void 0:a.count)?a.count:r.length;return{users:r.map(c),total:i,limit:n,offset:l}}async function p(e){let t=await h("/api/admin/roles",e,{method:"GET"});return(Array.isArray(t)?t:Array.isArray(null==t?void 0:t.items)?t.items:[]).map(u)}async function x(e,t,s){let a={};if("number"==typeof s.role_id&&(a.role_id=s.role_id),s.status){var r;a.status=null!==(r=o[s.status])&&void 0!==r?r:s.status}return c(await h("/api/admin/users/".concat(t),e,{method:"PATCH",body:JSON.stringify(a)}))}async function g(e,t){await h("/api/admin/users/".concat(t),e,{method:"DELETE"})}async function y(e,t,s){return u(await h("/api/admin/roles/".concat(t),e,{method:"PATCH",body:JSON.stringify(s)}))}async function v(e,t){var s,a;let r=await fetch((0,l.G)("/api/auth/register"),{method:"POST",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"},body:JSON.stringify(t),cache:"no-store"});if(!r.ok)throw await m(r);let n=await r.json(),i=c({...n,role_name:null!==(s=n.role_name)&&void 0!==s?s:"",status:null!==(a=n.status)&&void 0!==a?a:"pending_verification"});return n.full_name&&(i.full_name=n.full_name),i}var j=s(7648),b=s(8906);let N=(0,s(9205).Z)("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);function w(){let{user:e,accessToken:t,loading:s}=(0,n.a)(),[l,i]=(0,r.useState)([]),[o,d]=(0,r.useState)([]),[c,u]=(0,r.useState)(!0),[m,h]=(0,r.useState)(null),[w,_]=(0,r.useState)(""),[k,A]=(0,r.useState)(null),[T,C]=(0,r.useState)(null),[S,U]=(0,r.useState)(!1),[H,E]=(0,r.useState)({email:"",password:"",first_name:"",last_name:"",role_id:2}),[R,D]=(0,r.useState)(!1),[P,L]=(0,r.useState)(null);(0,r.useEffect)(()=>{t&&e&&"admin"===e.role_name&&q()},[t,null==e?void 0:e.role_name]);let q=async()=>{try{u(!0);let[e,s]=await Promise.all([f({accessToken:t,search:w}),p(t)]);i(Array.isArray(null==e?void 0:e.users)?e.users:[]),d(Array.isArray(s)?s:[]),h(null)}catch(e){h(e.message||"Failed to load admin data")}finally{u(!1)}},O=async(e,s)=>{try{A(e);let a=await x(t,e,{role_id:s});i(t=>t.map(t=>t.id===e?a:t))}catch(e){alert(e.message)}finally{A(null)}},F=async(e,s)=>{try{A(e);let a=await x(t,e,{status:s});i(t=>t.map(t=>t.id===e?a:t))}catch(e){alert(e.message)}finally{A(null)}},M=async(e,s)=>{try{C(e);let a=await y(t,e,{description:s});d(t=>t.map(t=>t.id===e?a:t))}catch(e){alert(e.message)}finally{C(null)}},z=async e=>{let s=l.find(t=>t.id===e);if(s&&confirm("Delete user ".concat(s.email,"? This action cannot be undone.")))try{L(e),await g(t,e),i(t=>t.filter(t=>t.id!==e))}catch(e){alert(e.message||"Failed to delete user")}finally{L(null)}},J=async e=>{if(e.preventDefault(),!H.email||!H.password){alert("Email and password are required");return}try{D(!0);let e=await v(t,H);i(t=>[e,...t]),E({email:"",password:"",first_name:"",last_name:"",role_id:2}),U(!1),alert("User created successfully!")}catch(e){alert(e.message||"Failed to create user")}finally{D(!1)}};if(s||c)return(0,a.jsx)("div",{className:"flex items-center justify-center h-screen text-muted-foreground",children:"Loading..."});if(!e)return(0,a.jsxs)("div",{className:"p-8 text-center space-y-4",children:[(0,a.jsx)("h1",{className:"text-2xl font-semibold",children:"Authentication Required"}),(0,a.jsx)("p",{className:"text-muted-foreground",children:"You must be logged in to view this page."}),(0,a.jsx)(j.default,{href:"/login",className:"underline",children:"Go to Login"})]});if("admin"!==e.role_name)return(0,a.jsxs)("div",{className:"p-8 text-center space-y-4",children:[(0,a.jsx)("h1",{className:"text-2xl font-semibold",children:"Access Denied"}),(0,a.jsx)("p",{className:"text-muted-foreground",children:"You do not have permission to view administrative controls."}),(0,a.jsx)(j.default,{href:"/",className:"underline",children:"Return Home"})]});let I=Array.isArray(o)?o:[],W=Array.isArray(l)?l:[];return(0,a.jsxs)("div",{className:"flex flex-col h-screen",children:[(0,a.jsxs)("div",{className:"border-b p-4 flex items-center justify-between bg-muted/30",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(j.default,{href:"/",className:"text-muted-foreground hover:text-foreground mr-2",children:"← Back"}),(0,a.jsx)(b.Z,{className:"h-5 w-5"}),(0,a.jsx)("h1",{className:"text-xl font-semibold",children:"Admin Dashboard"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("input",{className:"border rounded px-2 py-1 text-sm",placeholder:"Search users",value:w,onChange:e=>_(e.target.value)}),(0,a.jsxs)("button",{onClick:q,className:"inline-flex items-center gap-1 border rounded px-3 py-1 text-sm hover:bg-muted",children:[(0,a.jsx)(N,{className:"h-4 w-4"})," Refresh"]})]})]}),m&&(0,a.jsx)("div",{className:"p-4 text-sm text-red-600",children:m}),c?(0,a.jsx)("div",{className:"flex-1 flex items-center justify-center text-muted-foreground",children:"Loading..."}):(0,a.jsxs)("div",{className:"flex-1 overflow-auto p-6 space-y-10",children:[(0,a.jsxs)("section",{children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-3",children:[(0,a.jsx)("h2",{className:"text-lg font-medium",children:"Users"}),(0,a.jsx)("button",{onClick:()=>U(!S),className:"px-3 py-1 bg-primary text-primary-foreground rounded text-sm hover:bg-primary/90",children:S?"Cancel":"Add User"})]}),S&&(0,a.jsxs)("div",{className:"mb-4 p-4 border rounded bg-muted/20",children:[(0,a.jsx)("h3",{className:"text-md font-medium mb-3",children:"Create New User"}),(0,a.jsxs)("form",{onSubmit:J,className:"grid grid-cols-2 gap-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Email *"}),(0,a.jsx)("input",{type:"email",required:!0,value:H.email,onChange:e=>E(t=>({...t,email:e.target.value})),className:"w-full border rounded px-2 py-1 text-sm"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Password *"}),(0,a.jsx)("input",{type:"password",required:!0,value:H.password,onChange:e=>E(t=>({...t,password:e.target.value})),className:"w-full border rounded px-2 py-1 text-sm"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-1",children:"First Name"}),(0,a.jsx)("input",{type:"text",value:H.first_name,onChange:e=>E(t=>({...t,first_name:e.target.value})),className:"w-full border rounded px-2 py-1 text-sm"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Last Name"}),(0,a.jsx)("input",{type:"text",value:H.last_name,onChange:e=>E(t=>({...t,last_name:e.target.value})),className:"w-full border rounded px-2 py-1 text-sm"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Role"}),(0,a.jsx)("select",{value:H.role_id,onChange:e=>E(t=>({...t,role_id:Number(e.target.value)})),className:"w-full border rounded px-2 py-1 text-sm",children:I.map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))})]}),(0,a.jsx)("div",{className:"flex items-end",children:(0,a.jsx)("button",{type:"submit",disabled:R,className:"px-4 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 disabled:opacity-50",children:R?"Creating...":"Create User"})})]})]}),(0,a.jsx)("div",{className:"overflow-x-auto border rounded",children:(0,a.jsxs)("table",{className:"min-w-full text-sm",children:[(0,a.jsx)("thead",{className:"bg-muted/50",children:(0,a.jsxs)("tr",{className:"text-left",children:[(0,a.jsx)("th",{className:"p-2",children:"ID"}),(0,a.jsx)("th",{className:"p-2",children:"Email"}),(0,a.jsx)("th",{className:"p-2",children:"Name"}),(0,a.jsx)("th",{className:"p-2",children:"Role"}),(0,a.jsx)("th",{className:"p-2",children:"Status"}),(0,a.jsx)("th",{className:"p-2",children:"Verified"}),(0,a.jsx)("th",{className:"p-2",children:"Updated"}),(0,a.jsx)("th",{className:"p-2",children:"Actions"})]})}),(0,a.jsxs)("tbody",{children:[W.map(t=>{var s;return(0,a.jsxs)("tr",{className:"border-t",children:[(0,a.jsx)("td",{className:"p-2 font-mono text-xs",children:t.id}),(0,a.jsx)("td",{className:"p-2",children:t.email}),(0,a.jsx)("td",{className:"p-2",children:t.full_name}),(0,a.jsx)("td",{className:"p-2",children:(0,a.jsx)("select",{className:"border rounded px-1 py-0.5 text-xs",value:t.role_id,disabled:k===t.id,onChange:e=>O(t.id,Number(e.target.value)),children:I.map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))})}),(0,a.jsx)("td",{className:"p-2",children:(0,a.jsxs)("select",{className:"border rounded px-1 py-0.5 text-xs",value:t.status,disabled:k===t.id,onChange:e=>F(t.id,e.target.value),children:[(0,a.jsx)("option",{value:"active",children:"active"}),(0,a.jsx)("option",{value:"disabled",children:"disabled"}),(0,a.jsx)("option",{value:"pending",children:"pending"})]})}),(0,a.jsx)("td",{className:"p-2 text-center",children:t.verified?"✅":"❌"}),(0,a.jsx)("td",{className:"p-2 text-xs text-muted-foreground",children:null===(s=t.updated_at)||void 0===s?void 0:s.replace("T"," ").substring(0,16)}),(0,a.jsx)("td",{className:"p-2",children:(0,a.jsx)("button",{onClick:()=>z(t.id),disabled:P===t.id||t.id===e.id,className:"text-xs px-2 py-0.5 rounded border border-red-600 text-red-600 hover:bg-red-600 hover:text-white disabled:opacity-40",title:t.id===e.id?"Cannot delete current logged in user":"Delete user",children:P===t.id?"Deleting...":"Delete"})})]},t.id)}),0===l.length&&(0,a.jsx)("tr",{children:(0,a.jsx)("td",{colSpan:8,className:"p-4 text-center text-muted-foreground",children:"No users found."})})]})]})})]}),(0,a.jsxs)("section",{children:[(0,a.jsx)("h2",{className:"text-lg font-medium mb-3",children:"Roles"}),(0,a.jsx)("div",{className:"overflow-x-auto border rounded",children:(0,a.jsxs)("table",{className:"min-w-full text-sm",children:[(0,a.jsx)("thead",{className:"bg-muted/50",children:(0,a.jsxs)("tr",{className:"text-left",children:[(0,a.jsx)("th",{className:"p-2",children:"ID"}),(0,a.jsx)("th",{className:"p-2",children:"Name"}),(0,a.jsx)("th",{className:"p-2",children:"Description"}),(0,a.jsx)("th",{className:"p-2",children:"System"}),(0,a.jsx)("th",{className:"p-2",children:"Permissions"})]})}),(0,a.jsx)("tbody",{children:I.map(e=>(0,a.jsxs)("tr",{className:"border-t",children:[(0,a.jsx)("td",{className:"p-2 font-mono text-xs",children:e.id}),(0,a.jsx)("td",{className:"p-2 font-medium",children:e.name}),(0,a.jsx)("td",{className:"p-2",children:e.system?(0,a.jsx)("span",{className:"text-muted-foreground text-xs",children:e.description||"—"}):(0,a.jsx)("input",{className:"border rounded px-1 py-0.5 text-xs w-56",defaultValue:e.description||"",disabled:T===e.id,onBlur:t=>{t.target.value!==e.description&&M(e.id,t.target.value)}})}),(0,a.jsx)("td",{className:"p-2 text-center",children:e.system?"\uD83D\uDD12":""}),(0,a.jsx)("td",{className:"p-2 text-xs",children:(0,a.jsxs)("div",{className:"flex flex-wrap gap-1 max-w-xs",children:[(e.permissions||[]).map(e=>(0,a.jsx)("span",{className:"px-1.5 py-0.5 rounded bg-secondary text-[10px] tracking-wide uppercase",children:e},e)),(!e.permissions||0===e.permissions.length)&&(0,a.jsx)("span",{className:"text-muted-foreground",children:"—"})]})})]},e.id))})]})})]})]})]})}},4508:function(e,t,s){"use strict";s.d(t,{G:function(){return l},cn:function(){return n}});var a=s(1994),r=s(3335);function n(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return(0,r.m6)((0,a.W)(t))}function l(e){return e}},9205:function(e,t,s){"use strict";s.d(t,{Z:function(){return o}});var a=s(2265);let r=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),n=function(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return t.filter((e,t,s)=>!!e&&""!==e.trim()&&s.indexOf(e)===t).join(" ").trim()};var l={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let i=(0,a.forwardRef)((e,t)=>{let{color:s="currentColor",size:r=24,strokeWidth:i=2,absoluteStrokeWidth:o,className:d="",children:c,iconNode:u,...m}=e;return(0,a.createElement)("svg",{ref:t,...l,width:r,height:r,stroke:s,strokeWidth:o?24*Number(i)/Number(r):i,className:n("lucide",d),...m},[...u.map(e=>{let[t,s]=e;return(0,a.createElement)(t,s)}),...Array.isArray(c)?c:[c]])}),o=(e,t)=>{let s=(0,a.forwardRef)((s,l)=>{let{className:o,...d}=s;return(0,a.createElement)(i,{ref:l,iconNode:t,className:n("lucide-".concat(r(e)),o),...d})});return s.displayName="".concat(e),s}},8906:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("Shield",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]])},1245:function(e,t,s){"use strict";s.d(t,{AuthProvider:function(){return o},a:function(){return d}});var a=s(7437),r=s(2265);let n=(0,r.createContext)(void 0),l="tsa_auth_v1";function i(e){try{localStorage.setItem(l,JSON.stringify(e))}catch(e){}}let o=e=>{let{children:t}=e,[s,o]=(0,r.useState)({user:null,accessToken:null,refreshToken:null,expiresAt:null,loading:!0,error:null}),d=e=>o(t=>({...t,...e})),c=e=>e;(0,r.useEffect)(()=>{let e=!1;return(async()=>{console.log("[AUTH] Initializing auth context");let t=function(){try{let e=localStorage.getItem(l);if(!e)return null;return JSON.parse(e)}catch(e){return null}}();if(console.log("[AUTH] Persisted state:",t?"Found tokens":"No tokens"),!(null==t?void 0:t.accessToken)){console.log("[AUTH] No access token found, setting loading false"),e||d({loading:!1});return}console.log("[AUTH] Found access token, loading user profile"),d({...t,loading:!0});try{let t=await fetch(c("/api/auth/health")).catch(()=>null);if(!t||!t.ok&&404!==t.status){e||d({loading:!1,error:"Auth service unavailable"});return}}catch(t){e||d({loading:!1,error:"Auth service unavailable"});return}try{console.log("[AUTH] Fetching user profile from /api/auth/me");let s=await fetch(c("/api/auth/me"),{headers:{Authorization:"Bearer ".concat(t.accessToken)}});if(console.log("[AUTH] Profile fetch response status:",s.status),s.ok){let t=await s.json();console.log("[AUTH] Profile loaded:",{id:t.id,email:t.email,password_change_required:t.password_change_required}),e||d({user:t,loading:!1})}else e||(d({loading:!1,accessToken:null,refreshToken:null,user:null}),i({}))}catch(t){e||d({loading:!1})}})(),()=>{e=!0}},[]);let u=(0,r.useCallback)(async(e,t)=>{console.log("[AUTH] Login attempt for:",e),d({loading:!0,error:null});try{var s;console.log("[AUTH] Sending login request to:",c("/api/auth/login"));let a=await fetch(c("/api/auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})});if(console.log("[AUTH] Login response status:",a.status),!a.ok){let e="Login failed";try{let t=await a.json();t&&"string"==typeof t.detail&&(e=t.detail)}catch(e){}return d({loading:!1,error:e}),!1}let r=null;try{r=await a.json()}catch(e){return d({loading:!1,error:"Malformed server response"}),!1}if(console.log("[AUTH] Login response data:",{hasAccessToken:!!r.access_token,hasRefreshToken:!!r.refresh_token,hasUser:!!r.user,userPasswordChangeRequired:null===(s=r.user)||void 0===s?void 0:s.password_change_required}),!r||"object"!=typeof r||!r.access_token||!r.refresh_token||"number"!=typeof r.expires_in||!r.user)return console.log("[AUTH] Invalid login response data"),d({loading:!1,error:"Unexpected auth response"}),!1;let n=Number.isFinite(r.expires_in)?r.expires_in:0,l=Date.now()+Math.max(0,1e3*n-5e3),o={accessToken:r.access_token,refreshToken:r.refresh_token,expiresAt:l,user:r.user};return console.log("[AUTH] Login successful, setting user state:",{email:r.user.email,password_change_required:r.user.password_change_required}),d({...o,loading:!1}),i(o),!0}catch(e){return d({loading:!1,error:"Network error"}),!1}},[]),m=(0,r.useCallback)(async e=>{d({loading:!0,error:null});try{let t=await fetch(c("/api/auth/register"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...e,role_id:e.role_id||2})});if(!t.ok){let e=(await t.json().catch(()=>({}))).detail||"Registration failed";return d({loading:!1,error:e}),!1}return d({loading:!1}),!0}catch(e){return d({loading:!1,error:"Network error"}),!1}},[]),h=(0,r.useCallback)(()=>{if(d({user:null,accessToken:null,refreshToken:null,expiresAt:null}),i({}),!window.location.pathname.startsWith("/login"))try{window.location.href="/login"}catch(e){}},[]);(0,r.useEffect)(()=>{if(globalThis._tsaFetchWrapped)return;let e=fetch;globalThis._tsaFetchWrapped=!0,globalThis.fetch=async function(){for(var t=arguments.length,s=Array(t),a=0;a<t;a++)s[a]=arguments[a];let r=await e(...s);if(401===r.status){let e="string"==typeof s[0]?s[0]:s[0].url;if(!e.includes("/api/auth/login")&&!e.includes("/api/auth/register")&&(h(),!window.location.pathname.startsWith("/login")))try{window.location.pathname="/login"}catch(e){}}return r}},[h]);let f=(0,r.useCallback)(async()=>{if(console.log("[AUTH] Refresh called"),!s.refreshToken){console.log("[AUTH] No refresh token available");return}if(f._inFlight){console.log("[AUTH] Refresh already in flight");return}console.log("[AUTH] Starting token refresh"),f._inFlight=!0;try{var e,t;let a=await fetch(c("/api/auth/refresh"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:s.refreshToken})});if(console.log("[AUTH] Refresh response status:",a.status),!a.ok)return console.log("[AUTH] Refresh failed, logging out"),h();let r=await a.json();console.log("[AUTH] Refresh successful, updated user:",{email:null===(e=r.user)||void 0===e?void 0:e.email,password_change_required:null===(t=r.user)||void 0===t?void 0:t.password_change_required});let n=1e3*r.expires_in,l=Date.now()+n-Math.min(5e3,Math.max(1e3,.08*n)),o={accessToken:r.access_token,expiresAt:l,user:r.user};d(o),i({...o,refreshToken:s.refreshToken})}catch(e){h()}finally{f._inFlight=!1}},[s.refreshToken,h]);(0,r.useEffect)(()=>{if(!s.expiresAt)return;let e=s.expiresAt-Date.now();if(e<=0){f();return}let t=e-.12*e;t<1500&&(t=Math.min(Math.max(e-500,0),1500));let a=setTimeout(()=>f(),t);return()=>clearTimeout(a)},[s.expiresAt,f]);let p={...s,login:u,register:m,logout:h,refresh:f};return(0,a.jsx)(n.Provider,{value:p,children:t})};function d(){let e=(0,r.useContext)(n);if(!e)throw Error("useAuth must be used within AuthProvider");return e}}},function(e){e.O(0,[137,648,971,117,744],function(){return e(e.s=5007)}),_N_E=e.O()}]);