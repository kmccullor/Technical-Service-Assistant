"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[60],{2672:function(e,t,n){n.d(t,{AG:function(){return v},Nq:function(){return h},h8:function(){return m},iH:function(){return _},ju:function(){return y},r4:function(){return g},ul:function(){return p},xv:function(){return f},yw:function(){return d}});var r=n(4508);let o={active:"active",inactive:"disabled",suspended:"disabled",pending_verification:"pending"},i={active:"active",disabled:"inactive",pending:"pending_verification"};function a(e){if(!e)return null;let t=e.trim();return t.length?t:null}function s(e){var t,n,r,i,s,l,u;let c="first_name"in e?e.first_name:null,d="last_name"in e?e.last_name:null,f=null!==(n=null==c?void 0:c.trim())&&void 0!==n?n:"",h=null!==(r=null==d?void 0:d.trim())&&void 0!==r?r:"",m=("full_name"in e&&null!==(i=null===(t=e.full_name)||void 0===t?void 0:t.trim())&&void 0!==i?i:"")||"".concat(f," ").concat(h).trim()||e.email,p=null!==(s="string"==typeof e.status?e.status:void 0)&&void 0!==s?s:"active";return{id:e.id,email:e.email,first_name:a(c),last_name:a(d),role_id:function(e){if("number"==typeof e)return e;if("string"==typeof e){let t=Number.parseInt(e,10);if(Number.isFinite(t))return t}return 0}(e.role_id),role_name:null!==(l=e.role_name)&&void 0!==l?l:"",status:null!==(u=o[p])&&void 0!==u?u:"active",full_name:m,verified:!!(!("verified"in e)||e.verified),created_at:e.created_at,updated_at:e.updated_at}}function l(e){var t;return{id:e.id,name:e.name,description:null!==(t=e.description)&&void 0!==t?t:null,permissions:Array.isArray(e.permissions)?e.permissions:[],system:!!("boolean"==typeof e.is_system?e.is_system:"boolean"==typeof e.system?e.system:e.is_system_role),user_count:"number"==typeof e.user_count?e.user_count:0}}async function u(e){try{let t=await e.clone().json();if("string"==typeof(null==t?void 0:t.detail))return Error(t.detail);if("string"==typeof(null==t?void 0:t.message))return Error(t.message)}catch(e){}return Error(e.statusText||"Request failed")}async function c(e,t,n){let o=new Headers(null==n?void 0:n.headers);o.set("Authorization","Bearer ".concat(t)),(null==n?void 0:n.body)&&!o.has("Content-Type")&&o.set("Content-Type","application/json");let i=await fetch((0,r.G)(e),{...n,headers:o,cache:"no-store"});if(!i.ok)throw await u(i);if(204!==i.status)return await i.json()}async function d(e){let t=new URLSearchParams;e.limit&&t.set("limit",String(e.limit)),e.offset&&t.set("offset",String(e.offset)),e.search&&t.set("search",e.search.trim());let n=t.toString(),r=await c("/api/admin/users".concat(n?"?".concat(n):""),e.accessToken,{method:"GET"}),o=Array.isArray(null==r?void 0:r.items)?r.items:Array.isArray(null==r?void 0:r.users)?r.users:[],i="number"==typeof(null==r?void 0:r.limit)?r.limit:"number"==typeof(null==r?void 0:r.page_size)?r.page_size:o.length,a="number"==typeof(null==r?void 0:r.offset)?r.offset:"number"==typeof(null==r?void 0:r.page)&&i?Math.max(r.page-1,0)*i:0,l="number"==typeof(null==r?void 0:r.total)?r.total:"number"==typeof(null==r?void 0:r.count)?r.count:o.length;return{users:o.map(s),total:l,limit:i,offset:a}}async function f(e){let t=await c("/api/admin/roles",e,{method:"GET"});return(Array.isArray(t)?t:Array.isArray(null==t?void 0:t.items)?t.items:[]).map(l)}async function h(e,t,n){let r={};if("number"==typeof n.role_id&&(r.role_id=n.role_id),n.status){var o;r.status=null!==(o=i[n.status])&&void 0!==o?o:n.status}return s(await c("/api/admin/users/".concat(t),e,{method:"PATCH",body:JSON.stringify(r)}))}async function m(e,t){await c("/api/admin/users/".concat(t),e,{method:"DELETE"})}async function p(e,t,n){return l(await c("/api/admin/roles/".concat(t),e,{method:"PATCH",body:JSON.stringify(n)}))}async function g(e,t){var n,o;let i=await fetch((0,r.G)("/api/auth/register"),{method:"POST",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"},body:JSON.stringify(t),cache:"no-store"});if(!i.ok)throw await u(i);let a=await i.json(),l=s({...a,role_name:null!==(n=a.role_name)&&void 0!==n?n:"",status:null!==(o=a.status)&&void 0!==o?o:"pending_verification"});return a.full_name&&(l.full_name=a.full_name),l}async function y(e){let t={};return e.limit&&(t.limit=e.limit),e.offset&&(t.offset=e.offset),e.search_term&&(t.search_term=e.search_term),e.document_type&&(t.document_type=e.document_type),e.product_name&&(t.product_name=e.product_name),e.privacy_level&&(t.privacy_level=e.privacy_level),e.sort_by&&(t.sort_by=e.sort_by),e.sort_order&&(t.sort_order=e.sort_order),await c("/api/documents/list",e.accessToken,{method:"POST",body:JSON.stringify(t)})}async function _(e,t){await c("/api/documents/".concat(t),e,{method:"DELETE"})}async function v(e,t){let n=new Headers;n.set("Authorization","Bearer ".concat(e));let o=await fetch((0,r.G)("/api/documents/".concat(t,"/download")),{method:"GET",headers:n});if(!o.ok)throw await u(o);return o.blob()}},4508:function(e,t,n){n.d(t,{G:function(){return a},cn:function(){return i}});var r=n(1994),o=n(3335);function i(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return(0,o.m6)((0,r.W)(t))}function a(e){return e}},1245:function(e,t,n){n.d(t,{AuthProvider:function(){return l},a:function(){return u}});var r=n(7437),o=n(2265);let i=(0,o.createContext)(void 0),a="tsa_auth_v1";function s(e){try{localStorage.setItem(a,JSON.stringify(e))}catch(e){}}let l=e=>{let{children:t}=e,[n,l]=(0,o.useState)({user:null,accessToken:null,refreshToken:null,expiresAt:null,loading:!0,error:null}),u=e=>l(t=>({...t,...e})),c=e=>e;(0,o.useEffect)(()=>{let e=!1;return(async()=>{console.log("[AUTH] Initializing auth context");let t=function(){try{let e=localStorage.getItem(a);if(!e)return null;return JSON.parse(e)}catch(e){return null}}();if(console.log("[AUTH] Persisted state:",t?"Found tokens":"No tokens"),!(null==t?void 0:t.accessToken)){console.log("[AUTH] No access token found, setting loading false"),e||u({loading:!1});return}console.log("[AUTH] Found access token, loading user profile"),u({...t,loading:!0});try{let t=await fetch(c("/api/auth/health")).catch(()=>null);if(!t||!t.ok&&404!==t.status){e||u({loading:!1,error:"Auth service unavailable"});return}}catch(t){e||u({loading:!1,error:"Auth service unavailable"});return}try{console.log("[AUTH] Fetching user profile from /api/auth/me");let n=await fetch(c("/api/auth/me"),{headers:{Authorization:"Bearer ".concat(t.accessToken)}});if(console.log("[AUTH] Profile fetch response status:",n.status),n.ok){let t=await n.json();console.log("[AUTH] Profile loaded:",{id:t.id,email:t.email,password_change_required:t.password_change_required}),e||u({user:t,loading:!1})}else e||(u({loading:!1,accessToken:null,refreshToken:null,user:null}),s({}))}catch(t){e||u({loading:!1})}})(),()=>{e=!0}},[]);let d=(0,o.useCallback)(async(e,t)=>{console.log("[AUTH] Login attempt for:",e),u({loading:!0,error:null});try{var n;console.log("[AUTH] Sending login request to:",c("/api/auth/login"));let r=await fetch(c("/api/auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})});if(console.log("[AUTH] Login response status:",r.status),!r.ok){let e="Login failed";try{let t=await r.json();t&&"string"==typeof t.detail&&(e=t.detail)}catch(e){}return u({loading:!1,error:e}),!1}let o=null;try{o=await r.json()}catch(e){return u({loading:!1,error:"Malformed server response"}),!1}if(console.log("[AUTH] Login response data:",{hasAccessToken:!!o.access_token,hasRefreshToken:!!o.refresh_token,hasUser:!!o.user,userPasswordChangeRequired:null===(n=o.user)||void 0===n?void 0:n.password_change_required}),!o||"object"!=typeof o||!o.access_token||!o.refresh_token||"number"!=typeof o.expires_in||!o.user)return console.log("[AUTH] Invalid login response data"),u({loading:!1,error:"Unexpected auth response"}),!1;let i=Number.isFinite(o.expires_in)?o.expires_in:0,a=Date.now()+Math.max(0,1e3*i-5e3),l={accessToken:o.access_token,refreshToken:o.refresh_token,expiresAt:a,user:o.user};return console.log("[AUTH] Login successful, setting user state:",{email:o.user.email,password_change_required:o.user.password_change_required}),u({...l,loading:!1}),s(l),!0}catch(e){return u({loading:!1,error:"Network error"}),!1}},[]),f=(0,o.useCallback)(async e=>{u({loading:!0,error:null});try{let t=await fetch(c("/api/auth/register"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...e,role_id:e.role_id||2})});if(!t.ok){let e=(await t.json().catch(()=>({}))).detail||"Registration failed";return u({loading:!1,error:e}),!1}return u({loading:!1}),!0}catch(e){return u({loading:!1,error:"Network error"}),!1}},[]),h=(0,o.useCallback)(()=>{if(u({user:null,accessToken:null,refreshToken:null,expiresAt:null}),s({}),!window.location.pathname.startsWith("/login"))try{window.location.href="/login"}catch(e){}},[]);(0,o.useEffect)(()=>{if(globalThis._tsaFetchWrapped)return;let e=fetch;globalThis._tsaFetchWrapped=!0,globalThis.fetch=async function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];let o=await e(...n);if(401===o.status){let e="string"==typeof n[0]?n[0]:n[0].url;if(!e.includes("/api/auth/login")&&!e.includes("/api/auth/register")&&(h(),!window.location.pathname.startsWith("/login")))try{window.location.pathname="/login"}catch(e){}}return o}},[h]);let m=(0,o.useCallback)(async()=>{if(console.log("[AUTH] Refresh called"),!n.refreshToken){console.log("[AUTH] No refresh token available");return}if(m._inFlight){console.log("[AUTH] Refresh already in flight");return}console.log("[AUTH] Starting token refresh"),m._inFlight=!0;try{var e,t;let r=await fetch(c("/api/auth/refresh"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:n.refreshToken})});if(console.log("[AUTH] Refresh response status:",r.status),!r.ok)return console.log("[AUTH] Refresh failed, logging out"),h();let o=await r.json();console.log("[AUTH] Refresh successful, updated user:",{email:null===(e=o.user)||void 0===e?void 0:e.email,password_change_required:null===(t=o.user)||void 0===t?void 0:t.password_change_required});let i=1e3*o.expires_in,a=Date.now()+i-Math.min(5e3,Math.max(1e3,.08*i)),l={accessToken:o.access_token,expiresAt:a,user:o.user};u(l),s({...l,refreshToken:n.refreshToken})}catch(e){h()}finally{m._inFlight=!1}},[n.refreshToken,h]);(0,o.useEffect)(()=>{if(!n.expiresAt)return;let e=n.expiresAt-Date.now();if(e<=0){m();return}let t=e-.12*e;t<1500&&(t=Math.min(Math.max(e-500,0),1500));let r=setTimeout(()=>m(),t);return()=>clearTimeout(r)},[n.expiresAt,m]);let p={...n,login:d,register:f,logout:h,refresh:m};return(0,r.jsx)(i.Provider,{value:p,children:t})};function u(){let e=(0,o.useContext)(i);if(!e)throw Error("useAuth must be used within AuthProvider");return e}}}]);