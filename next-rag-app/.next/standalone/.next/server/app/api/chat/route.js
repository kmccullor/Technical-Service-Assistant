"use strict";(()=>{var e={};e.id=744,e.ids=[744],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8678:e=>{e.exports=import("pg")},539:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{originalPathname:()=>f,patchFetch:()=>l,requestAsyncStorage:()=>d,routeModule:()=>u,serverHooks:()=>h,staticGenerationAsyncStorage:()=>p});var o=n(9303),a=n(8716),s=n(670),i=n(6021),c=e([i]);i=(c.then?(await c)():c)[0];let u=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/chat/route",pathname:"/api/chat",filename:"route",bundlePath:"app/api/chat/route"},resolvedPagePath:"/home/kmccullor/Projects/Technical-Service-Assistant/next-rag-app/app/api/chat/route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:d,staticGenerationAsyncStorage:p,serverHooks:h}=u,f="/api/chat/route";function l(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:p})}r()}catch(e){r(e)}})},6021:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{POST:()=>d});var o=n(1621),a=n(7395),s=n(306),i=n(7745),c=n(1445),l=n(2405),u=e([a]);async function d(e){try{let t;let n=await e.json();console.log("Chat API received body:",JSON.stringify(n,null,2));let r=e.headers.get("authorization"),u=await (0,l.k)(r);if(!u)return new Response("Unauthorized",{status:401});let{conversationId:d,message:p,displayMessage:h,useWebFallback:f=!0,temperature:m=.7,maxTokens:y=1024}=n;if(!p||"string"!=typeof p||!p.trim())return console.log("Error: Message is required"),new Response("Message is required",{status:400});console.log("Processing user message:",p);let _="true"===process.env.USE_LOCAL_MODELS,w=process.env.OPENAI_API_KEY;if(console.log("Model configuration:",{useLocalModels:_,hasOpenaiKey:!!w}),!_&&(!w||"sk-your-openai-api-key-here"===w)){console.log("Neither local models nor OpenAI API key configured, returning test response");let e=new TextEncoder,n=new ReadableStream({start(n){for(let r of(n.enqueue(e.encode(`data: ${JSON.stringify({type:"conversation_id",conversationId:t})}

`)),n.enqueue(e.encode(`data: ${JSON.stringify({type:"sources",sources:[],method:"fallback"})}

`)),"Hello! I'm your RAG assistant. To enable full functionality, please configure your OpenAI API key in the .env.local file or set USE_LOCAL_MODELS=true. I can see you have documents loaded in the database, but I need either local models or an OpenAI API key to search and answer questions about them."))n.enqueue(e.encode(`data: ${JSON.stringify({type:"token",token:r})}

`));n.enqueue(e.encode(`data: ${JSON.stringify({type:"done"})}

`)),n.close()}});return new Response(n,{headers:{"Content-Type":"text/plain; charset=utf-8","Cache-Control":"no-cache",Connection:"keep-alive"}})}let g=(h??p).trim(),A=g||"New conversation",v=A.length>50?`${A.slice(0,50)}...`:A;if(d){let e=await a.db.select({id:s.p5.id}).from(s.p5).where((0,i.xD)((0,i.eq)(s.p5.id,d),(0,i.eq)(s.p5.userId,u.id))).limit(1);if(0===e.length)return new Response("Conversation not found",{status:404});t=d}else{let[e]=await a.db.insert(s.p5).values({title:v,userId:u.id}).returning({id:s.p5.id});t=e.id}let N=(await a.db.select({role:s.sY.role,content:s.sY.content,createdAt:s.sY.createdAt}).from(s.sY).where((0,i.eq)(s.sY.conversationId,t)).orderBy((0,c.C)(s.sY.createdAt)).limit(30)).reverse().map(e=>{let t="assistant"===e.role?"Assistant":"User";return`${t}: ${e.content??""}`}).join("\n"),L=[];N&&L.push(`Previous conversation context:
${N}`),L.push(`Current user request:
${p}`);let b=L.join("\n\n"),S=await (0,o.$)(b,{useWebFallback:f,temperature:m,maxTokens:y,confidenceThreshold:.3});await a.db.insert(s.sY).values({conversationId:t,role:"user",content:g}),await a.db.update(s.p5).set({updatedAt:new Date}).where((0,i.eq)(s.p5.id,t));let k=new TextEncoder,R="",T=new ReadableStream({async start(e){try{for await(let n of(e.enqueue(k.encode(`data: ${JSON.stringify({type:"conversation_id",conversationId:t})}

`)),e.enqueue(k.encode(`data: ${JSON.stringify({type:"sources",sources:S.sources,confidence:S.confidence,method:S.method})}

`)),S.textStream))R+=n,e.enqueue(k.encode(`data: ${JSON.stringify({type:"token",token:n})}

`));await a.db.insert(s.sY).values({conversationId:t,role:"assistant",content:R,citations:S.sources.map(e=>({title:e.document.title,source:e.document.source,content:e.content?.slice(0,200)+"..."}))}),await a.db.update(s.p5).set({updatedAt:new Date}).where((0,i.eq)(s.p5.id,t)),e.enqueue(k.encode(`data: ${JSON.stringify({type:"done",messageId:"temp-id"})}

`)),e.close()}catch(t){console.error("Streaming error:",t),e.enqueue(k.encode(`data: ${JSON.stringify({type:"error",error:"An error occurred while processing your request"})}

`)),e.close()}}});return new Response(T,{headers:{"Content-Type":"text/plain; charset=utf-8","Cache-Control":"no-cache",Connection:"keep-alive"}})}catch(e){return console.error("Chat API error:",e),new Response("Internal server error",{status:500})}}a=(u.then?(await u)():u)[0],r()}catch(e){r(e)}})},7395:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.d(t,{db:()=>l});var o=n(8029),a=n(8678),s=e([a,o]);[a,o]=s.then?(await s)():s;let i=process.env.DATABASE_SSL?.toLowerCase()==="true"||process.env.DATABASE_SSL?.toLowerCase()==="require",c=globalThis.__tsaDbPool||new a.Pool({connectionString:"postgresql://postgres:postgres@localhost:5432/vector_db",ssl:i?{rejectUnauthorized:!1}:void 0}),l=(0,o.tS)(c);r()}catch(e){r(e)}})},306:(e,t,n)=>{n.d(t,{De:()=>d,p5:()=>l,sY:()=>u,yD:()=>p});var r=n(7561),o=n(5961),a=n(2140),s=n(2941),i=n(1575),c=n(8680);let l=(0,r.af)("conversations",{id:(0,o.eP)("id").primaryKey(),title:(0,a.fL)("title").notNull(),userId:(0,s._L)("user_id"),createdAt:(0,i.AB)("created_at",{withTimezone:!0}).defaultNow().notNull(),updatedAt:(0,i.AB)("updated_at",{withTimezone:!0}).defaultNow(),lastReviewedAt:(0,i.AB)("last_reviewed_at",{withTimezone:!0})}),u=(0,r.af)("messages",{id:(0,o.eP)("id").primaryKey(),conversationId:(0,s._L)("conversation_id").notNull().references(()=>l.id,{onDelete:"cascade"}),role:(0,a.fL)("role").notNull(),content:(0,a.fL)("content").notNull(),citations:(0,c.JB)("citations").$type(),createdAt:(0,i.AB)("created_at",{withTimezone:!0}).defaultNow().notNull()}),d=(0,r.af)("documents",{id:(0,o.eP)("id").primaryKey(),fileName:(0,a.fL)("file_name").notNull(),title:(0,a.fL)("title").notNull(),description:(0,a.fL)("description"),fileHash:(0,a.fL)("file_hash"),fileSize:(0,s._L)("file_size"),mimeType:(0,a.fL)("mime_type"),documentType:(0,a.fL)("document_type"),productName:(0,a.fL)("product_name"),productVersion:(0,a.fL)("product_version"),privacyLevel:(0,a.fL)("privacy_level"),processedAt:(0,i.AB)("processed_at",{withTimezone:!0}),createdAt:(0,i.AB)("created_at",{withTimezone:!0}).defaultNow().notNull(),updatedAt:(0,i.AB)("updated_at",{withTimezone:!0}).defaultNow().notNull()}),p=(0,r.af)("document_chunks",{id:(0,o.eP)("id").primaryKey(),documentId:(0,s._L)("document_id").notNull().references(()=>d.id,{onDelete:"cascade"}),chunkIndex:(0,s._L)("chunk_index"),pageNumber:(0,s._L)("page_number"),chunkType:(0,a.fL)("chunk_type"),content:(0,a.fL)("content").notNull(),contentHash:(0,a.fL)("content_hash"),contentLength:(0,s._L)("content_length").default(0).notNull(),metadata:(0,c.JB)("metadata").$type().default({}),embedding:(0,c.JB)("embedding").$type(),createdAt:(0,i.AB)("created_at",{withTimezone:!0}).defaultNow().notNull(),updatedAt:(0,i.AB)("updated_at",{withTimezone:!0}).defaultNow()})},1621:(e,t,n)=>{n.d(t,{$:()=>a});var r=n(553);async function o(e,t){let n=(0,r.c)("/api/rag-chat"),o={query:e,use_web_fallback:t.useWebFallback,temperature:t.temperature,max_tokens:t.maxTokens,confidence_threshold:t.confidenceThreshold},a=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!a.ok){let e=a.statusText;try{let t=await a.clone().json();"string"==typeof t?.detail&&(e=t.detail)}catch{}throw Error(`RAG backend request failed (${a.status}): ${e||"unknown error"}`)}return await a.json()}async function a(e,t={}){let n=await o(e,t);return{textStream:function(e,t=80){return async function*(){for(let n=0;n<e.length;n+=t)yield e.slice(n,Math.min(e.length,n+t))}()}("string"==typeof n.response?n.response:""),sources:Array.isArray(n.context_used)?n.context_used.map((e,t)=>{let r=`Context ${t+1}`,o="Document";if(n.source_metadata&&n.source_metadata[t]){let e=n.source_metadata[t];e.section_title?r=e.section_title:e.title&&(r=e.title);let a=e.file_name||e.title;!a&&r.includes(":")&&(a=r.split(":")[0].trim()),a||(a="Document");let s=[a];e.page_number&&s.push(`Page ${e.page_number}`),e.section_title&&s.push(e.section_title),o=s.join(", ")}else{for(let t of e.split("\n").filter(e=>e.trim()).slice(0,3)){let e=t.trim();if(e.length>10&&e.length<100&&(/^[A-Z][^.!?]*$/.test(e)||e.includes(":"))){r=e;break}}if(n.search_method?.includes("web")||n.search_method?.includes("hybrid")){if(e.includes("URL:")){let t=e.match(/URL:\s*(https?:\/\/[^\s]+)/);t&&(o=new URL(t[1]).hostname)}else n.search_method?.includes("web")&&(o="Web Search")}}return{document:{title:r,source:o},content:e,score:n.fusion_metadata?.scores?.[t]}}):[],confidence:Number.isFinite(n.confidence_score)?n.confidence_score:0,method:n.search_method??"documents"}}},553:(e,t,n)=>{n.d(t,{c:()=>r});function r(e){let t=function(){for(let e of[process.env.RERANKER_BASE_URL,process.env.RERANKER_INTERNAL_URL,process.env.RERANKER_URL,""]){let t=e?function(e){if(!e)return null;let t=e.trim();if(!t)return null;try{let e=new URL(t);if("3000"===e.port)return null;return t.replace(/\/$/,"")}catch{return null}}(e):null;if(t)return t}return"http://localhost:8008"}(),n=e.startsWith("/")?e:`/${e}`;return`${t}${n}`}},2405:(e,t,n)=>{n.d(t,{k:()=>o});var r=n(553);async function o(e){if(!e)return null;try{let t=await fetch((0,r.c)("/api/auth/me"),{method:"GET",headers:{Authorization:e},cache:"no-store"});if(!t.ok)return null;let n=await t.json();if(!n||"number"!=typeof n.id)return null;return n}catch(e){return console.error("Failed to fetch current user:",e),null}}},9303:(e,t,n)=>{e.exports=n(517)}};var t=require("../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[8948,8029],()=>n(539));module.exports=r})();