version: '3.8'

services:
  # Next.js RAG Application
  rag-app:
    build: .
    restart: unless-stopped
    environment:
      # Database - Connect to existing pgvector container
      - DATABASE_URL=postgresql://postgres:postgres@pgvector:5432/vector_db
      
      # Local AI Models - Connect to existing Ollama containers
      - USE_LOCAL_MODELS=true
      - OLLAMA_BASE_URL=http://ollama-server-1:11434
      - OLLAMA_INSTANCES=http://ollama-server-1:11434,http://ollama-server-2:11434,http://ollama-server-3:11434,http://ollama-server-4:11434
      - EMBEDDING_MODEL=nomic-embed-text:v1.5
      - CHAT_MODEL=mistral:7b
      
      # App Configuration - RAG Performance Optimized
      - NODE_ENV=production
      - NEXT_PUBLIC_APP_URL=http://RNI-LLM-01.lab.sensus.net:3000
      - RERANKER_ENABLED=true
      - CONFIDENCE_THRESHOLD=0.2
      - VECTOR_WEIGHT=0.6
      - LEXICAL_WEIGHT=0.4
      - MAX_TOKENS=1024
      - TEMPERATURE=0.3
      - WEB_SEARCH_ENABLED=false
      - CACHE_TTL=3600
      - OLLAMA_TIMEOUT=30000
      - REQUEST_TIMEOUT=45000
      
      # Performance & Caching
      - REDIS_URL=redis://redis-cache:6379
      
      # Disabled External Services (using local only)
      - COHERE_API_KEY=disabled-using-local
      - TAVILY_API_KEY=disabled-using-local
      - SERP_API_KEY=disabled-using-local
      - LANGFUSE_PUBLIC_KEY=disabled-using-local
      - LANGFUSE_SECRET_KEY=disabled-using-local
      
    ports:
      - "3000:3000"
    networks:
      - technical-service-assistant_default
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./uploads:/app/uploads
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  technical-service-assistant_default:
    external: true

# Note: Using existing external services:
# - PostgreSQL with pgvector: host.docker.internal:5432 (vector_db database)
# - Ollama instances: host.docker.internal:11434-11437
# - These are running as separate containers and will be accessed via host network